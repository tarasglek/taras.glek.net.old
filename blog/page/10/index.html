
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="Imagine a typical Firefox user who starts their Windows computer in order to surf the web. First app they launch is Firefox 4. Turned out that on &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/page/10/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:taras.glek.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/21/rude-surprise-startup-overhead-of-windows-font-apis/">Rude Surprise: Startup Overhead of Windows Font APIs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-21T05:33:14-08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine a typical Firefox user who starts their Windows computer in order to surf the web. First app they launch is Firefox 4. Turned out that on systems that support hardware-acceleration for 2D graphics, Firefox 4 takes minutes to startup. WTF? XPerf-aided investigation showed that, the Windows font enumeration code causes us to do 30x more disk IO (~300MB) than the rest of Firefox code.</p>

<p>In order to hardware accelerate Firefox, we switched from GDI to using DirectWrite for font stuffs. Apparently, DirectWrite is a wonderful api, but the implementation has some teething issues. DirectWrite opens a connection to the Font Service (and starts it if it isn&#8217;t already running), however if service fails to respond DirectWrite proceeds to enumerate all of the system fonts on the client-side. This isn&#8217;t cool for multiple reasons: a) it is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=602792">slow as hell</a> b) it causes Firefox to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=617266">run out of memory</a>(installing IE9 helps!) sooner.  This means that currently Firefox 4 starts up a lot slower than 3.6. <a href="http://blog.mozilla.org/nattokirai/">John Daggett</a> is busy working on a workaround by using older GDI APIs to enumerate fonts. Firefox is one of the first popular Windows applications to switch to DirectWrite, so we get to suffer the consequences.</p>

<p>Unfortunately it turns out that using Microsoft GDI APIs to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=600713">enumerate fonts</a> still causes a significant amount of disk IO (~30-60MB), John plans to fix that next.</p>

<p><strong>How Did We Miss This?</strong></p>

<p>This bug came from a fundamental difference of how developers and users start Firefox. A developer will restart Firefox a dozen times an hour. This means we rarely get to observe true cold startup. Our tests only measure warm startup (because most operating systems make it difficult to test cold startup). Windows is also incredibly slow to develop on, so a lot of us test in a virtual machine to speed things up and avoid rebooting the computer all the time. This also makes observing cold startup hard. Fortunately xperf makes IO much easier to observe. We should deploy xperf on our <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=609111">test infrastructure</a> as soon as possible.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/30/crapware-and-firefox/">Crapware and Firefox</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-30T03:14:20-08:00" pubdate data-updated="true">Nov 30<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I completely agree with <a href="http://weblogs.mozillazine.org/asa/archives/2010/11/why_do_they_think_th.html">Asa</a> that having unwanted crap forced upon the user is morally wrong. We should do a better job of undoing this kind of braindamage. In the meantime here is a brief rant on the parasitic underpinnings of crapware.</p>

<p>Until recently, I have been testing Firefox on my own installs of Windows. I had no idea how aggressive bundleware could be. Then I got this piece-of-crap i7 Acer laptop with Windows 7 (and relatively little crapware preinstalled) and tried to use it as my primary machine. Suddenly, I could reproduce a lot more &#8220;slow&#8221; scenarios. I even went further and tried installing common crapware known as AVG to reproduce more bugs.</p>

<p>Turns out almost every vendor tries to mix in crap into Firefox. Acer, Microsoft Office/Silverlight, Adobe flash/acrobat, Google, AVG, etc all added unwanted functionality to my Firefox. I marveled at all kinds of &#8220;helpful&#8221; functionality such as the wonderful ability to click on a link in a webpage and have Google chrome install without any warning that the webpage is about to execute a windows program. AVG adds a couple of extensions that make Firefox start up 0.5-4x slower.</p>

<p>So far I noticed 2 vectors of attack: plugins and extensions. Plugins are fun because those get added by registering bonus plugin directories. Plugin directories are usually just application directories that contain plugins. This means Firefox gets to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=614423">slowly</a> rummage through bonus application directories looking for what might be a plugin. Extensions are fun because unlike plugins (which affect most browsers on the computer), extensions are very browser-specific. Most extension crapware doesn&#8217;t yet support Chrome. Installing things like AVG retards Firefox performance while Chrome escapes unmolested.</p>

<p><a href="http://benjamin.smedbergs.us/blog/2010-11-29/software-integration-is-not-evil/">Benjamin</a>, I don&#8217;t think these software vendors are &#8220;doing exactly as we ask of them.&#8221;</p>

<p>Personally, I would like us to be a lot more aggressive about blacklisting ill-performing software. Ie we need to go above and beyond <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=476430">warning</a> users when crapware. I would like to to actively check performance of popular plugins/addons and ban them if they are substandard.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/23/of-linkers-and-avoiding-suck/">Of Linkers and Avoiding Suck</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-23T02:41:47-08:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There is a common fallacy that since linkers and compilers are written by really smart people, there aren&#8217;t any huge performance wins left in the toolchain. My theory is that the efficiency of any given codebase varies inversely with the number of people who tried to optimize it.</p>

<p>I have long complained of suboptimal binaries generated from our code. Modern profiling tools such as <a href="http://taras.glek.net/blog/2009/10/23/studying-library-io-systemtap-style/">systemtap</a> and <a href="http://taras.glek.net/blog/2010/04/07/icegrind-valgrind-plugin-for-optimizing-cold-startup/">icegrind</a> made this painfully obvious. Mike Hommey opted for actually doing something about it. What started as a simple ld.so hack grew into a<a href="http://glandium.org/blog/?p=1177"> badass binary-rewriting tool</a> (and the most interesting blog post I&#8217;ve read this year).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/16/performance-progress/">Performance Update. Fragmentation: Mostly Fixed. GCC: Work-in-progress.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-16T07:14:02-08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Fragmentation: SQLite &amp; Friends </strong></p>

<p>I am happy to report that the SQLite fragmentation <a href="http://taras.glek.net/blog/2010/09/07/fighting-fragmentation-sqlite/">problem</a> is now <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=581606">solved</a>. I copied my profile a month ago, and my places.sqlite is still in a single fragment! There was a similar <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592520">fix</a> done to Firefox disk cache. Thanks to helpful comments on my OSX preallocation <a href="http://taras.glek.net/blog/2010/09/09/help-wanted-does-fcntlf_preallocate-work-as-advertised-on-osx/">cry for help</a>, we now preallocate efficiently on OSX too.</p>

<p>Startup cache is the last <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=593349">remaining</a> bastion of fragmentation, but that&#8217;s already 10x better than it was a month ago. I have two complimentary solutions for that: either <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562406">omnijar startup cache generation</a> for core code and/or write the cache more <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586859">efficiently</a>.</p>

<p>Firefox 4 will be a lot more gentle on those spinning platters.</p>

<p><strong>GCC</strong></p>

<p>I helped Jan Hubicka on a GCC <a href="http://gcc.gnu.org/wiki/summit2010">summit paper</a>. Those nasty static initializers will not be a hassle in GCC 4.6!</p>

<p>I keep wanting to blog about how we switched to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=559964">GCC 4.5</a> and how life is wonderful, but life didn&#8217;t work out this way. So far we tried switching away from 4.3 compiler three times. The first time GCC completely failed in terms of -Os performance. C++ -Os is more bloated in 4.5 (because that option is benchmarked on C apps). Then it turned out that libffi was being <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=45623">miscompiled</a> (we also found a related bug in libffi). Last time, we tried switching to GCC 4.5 + -O3 since that performs much better than -Os, but that <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=609543#c45">broke</a> sunspider. Hopefully we can fix the sunspider issue and try again next week. I would really like to utilize GCC <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=418866">PGO</a> to produce fastest possible Linux Firefox builds.</p>

<p>Nonetheless I happy with recent GCC progress. With Jan&#8217;s help, GCC will eventually be very good at compiling Mozilla. In my spare cycles I&#8217;ve been working on setting up GCC benchmarks using Mozilla to help avoid future surprises like we discovered in GCC 4.5. More on this later.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/10/04/diagnosing-slow-startup/">Diagnosing Slow Startup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-04T10:30:56-07:00" pubdate data-updated="true">Oct 4<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I spent last week trying to reproduce slow startup on Windows. Some users were reporting >30 second startup, supernova_00 has been feeding me <a href="https://developer.mozilla.org/En/Profiling_with_Xperf">xperf</a> traces on IRC reproducing slow startups.</p>

<p><strong>Startup Bugs</strong></p>

<p>Turns out that if a website uses non-standard font names this can trigger Firefox to start parsing every single font on the system, freezing the browser in the meantime. Turns out facebook does this :(. This is now a blocker <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=600713">bug 600713</a>. This bug has the unfortunate effect of overshadowing any startup improvements in Firefox 4.</p>

<p>We have some code to keep our databases in good shape by VACUUMing them. This is getting revamped in Firefox in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=541373">bug 541373</a>. In the meantime, for many current users performance suffers due to missing vacuums. If you are suffering from slow Firefox startup, and/or slow Awesomebar try this <a href="http://mozillalinks.org/wp/2009/08/vacuum-firefox-databases-for-better-performance-now-with-no-restart/">manual vacuum</a>. This helps in older Firefox releases, but in Firefox 4 this has the effect of supercharging the SQLite database performance by switching to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=416330">32K pages</a>.</p>

<p><strong>Scareware</strong></p>

<p>Another fun discovery was the effect of anti-virus software(AVG in this case). Like an annoying pet, AVG has to have a sniff and fondle every file that Firefox opens on startup. Apparently this is a feature called on-demand scanning, yuck.</p>

<p>But the fun doesn&#8217;t stop there, Windows has a wonderful <a href="http://en.wikipedia.org/wiki/Prefetcher">prefetch</a> mechanism that speeds up app startup. Unfortunately for supernova_00, \Windows\Prefetch just wouldn&#8217;t get populated with Firefox info, meaning that Windows wasn&#8217;t optimizing Firefox startup. Once I installed AVG, I ran into the same problem. Uninstalling AVG didn&#8217;t help. For whatever reason deleting every file in \Windows\Prefetch fixes that problem. For both of us prefetch got repopulated after being cleaned.</p>

<p><strong>XPerf</strong></p>

<p>Microsoft XPerf makes trivial to optimize cold startup. None of the other OSes have precanned analyses showing how much each individual file access is contributing to slow startup.</p>

<p>If you have a startup problem, I&#8217;m much more likely to be able to reproduce it if the report comes with an xperf trace. To get xperf run the Microsoft Platform SDK <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=6b6c21d2-2006-4afa-9702-529fa782d63b&amp;displaylang=en">installer</a>, select &#8220;Windows Performance Toolkit&#8221;.</p>

<p>To record an IO trace:</p>

<ol>
<li>Reboot</li>
<li>run cmd.exe as Administrator</li>
<li>xperf -on latency+FILE_IO+FILE_IO_INIT+DISK_IO</li>
<li>run Firefox, reproduce the bug</li>
<li>xperf -d report.etl</li>
<li>Run xperf report.etl to view the report.
Click on &#8220;IO Counts&#8221; or &#8220;Hard faults&#8221; graph, select &#8220;Summary Table&#8221;. &#8220;IO Time (ms)&#8221; is the interesting column there. To get an idea of the sequence of IO operations, export the summary table to .csv and load it in a spreadsheet/grep/whatever. Every Firefox developer should give xperf a try, addon authors are encouraged too.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/14/firefox-4-jar-jar-jar/">Firefox 4: Jar Jar Jar</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-14T03:32:35-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Opening files is relatively expensive. There is a small syscall overhead and a higher overhead of fetching data from disk. Depending on physical data layout and disk type, this can leave modern CPUs twiddling their thumbs for a long time while the disk skips around fetching all of the different file pieces.</p>

<p><strong>Optimization #1: Fewer naked files</strong></p>

<p>About two years ago I started gathering naked files on disk and shoving them into jars (eg <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=508421">bug 508421</a>). We made jar reading as efficient as possible by cleaning up code and switching to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=504864">mmap</a>. Eventually all application data files read from disk during &#8220;normal&#8221; startup ended up in jars. Unfortunately we ended up with four jars (toolkit, chrome + 2 locale jars), which felt silly. Due to limitations in XPCOM, a lot of naked files were still read from disk on version upgrades and extension installation.</p>

<p><strong>Optimization #2: One jar to rule them all</strong></p>

<p>Recently Michael Wu unleashed a can of <a href="http://blog.mozilla.org/mwu/2010/08/13/omnijar-how-does-it-work/">omnijar</a> whoopass. This was a massive effort driven by Android packaging requirements. Now application startup data is always being read from one file. This implies better data locality, less seeking, less waiting. One benefit of packing files tightly is that the OS speculatively reads data from disk in chunks that are usually larger than what the application requests. This makes reading nearby files free. Unfortunately there was no good way to predict the order that files will be accessed in without actually running Firefox, so there was more room for improvement.</p>

<p><strong>Optimization #3: Optimized jar layout </strong></p>

<p>So now that all of our data was in one file, the next logical step was to pack it intelligently. The only way to do this is to profile Firefox startup and then order the jar according to that. Unfortunately even once one lays out all of the jar entries sequentially we were still doing our io suboptimally. This was due to the fact that the zip index (jars are zip files) is traditionally located on the end of the file. Wikipedia <a href="http://en.wikipedia.org/wiki/ZIP_(file_format">entry</a>) has pictures to illustrate this.</p>

<p>In order to maximize readahead benefits and minimize disk seeks it would be nice to have the file index in the front of the file. So I changed our zip layout from</p>

<p><entry1><entry2>&#8230;<entryN><central directory><end of central directory></p>

<p>to</p>

<p><offset of the last entry read on startup><central directory><end of central directory><entry1><entry2>&#8230;<entryN><end of central directory></p>

<p>So all I did was change the offset in <end of central directory> to always be 4 (it can&#8217;t be 0 because anal zip programs balk at &#8220;NULL&#8221; central directory offsets). Then I added a second identical <end of central directory> entry to keep the the rule that the central directory is always followed by one. I also used the extra space forced upon me by overly vigilant zip programs to store a number indicating how much data we can preread on startup.</p>

<p>This yielded a 2-3x reduction in disk io over an unoptimized omnijar. This is on top of a >30-100x reduction achieved by going from naked files to omnijar.</p>

<p>The downside of my interpretation of the zip spec is that some zip programs expect zip files to be more rigid than the spec allows. Older versions of Firefox, Microsoft zip support in windows, WinRAR, unix zip programs, etc accept my optimized jars. 7zip, broken antivirus (it&#8217;s a security risk to be overly picky) <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=595473">fail</a>.</p>

<p>Trivia: this isn&#8217;t the first time we got tripped up by picky zip reading code. For example, the Android apk reader irritatingly insists at having a zip entry at byte zero of an Android package. This means that one can&#8217;t use apks to do the Android equivalent of self-extracting .exe files on Windows. Michael Wu is writing a custom library loader to deal with that :)</p>

<p><strong>Optimization #4: More Omnijar</strong></p>

<p>Feeling that omnijar wasn&#8217;t awesome enough, Michael Wu went ahead and <a href="http://blog.mozilla.org/mwu/2010/09/10/extensions-now-installed-packed/">omnijared extensions</a>. Most extensions will no longer need to be unpacked from xpi files. This also means that extension authors can opt to use the optimized jar format above to further speed up Firefox startup.</p>

<p><strong>Other jar optimizations</strong></p>

<p>Switching to jars via<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=520309"> startup cache</a> will allow us to further <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562406">optimize</a> our first startup. There is option of halving our jar IO further by actually making use of that readahead integer I added to optimized jars.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/09/help-wanted-does-fcntlf_preallocate-work-as-advertised-on-osx/">Help Wanted: Does fcntl(F_PREALLOCATE) Work as Advertised on OSX?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-09T07:06:11-07:00" pubdate data-updated="true">Sep 9<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To fight fragmentation it is best to tell the OS to allocate a continuous chunk of space for your file. With specialized APIs, the OS can do this without performing any IO (not counting metadata). I am adding support for this as part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592520">bug 592520</a>.  Linux features <a href="http://linux.die.net/man/3/posix_fallocate">posix_fadvise</a> for preallocating files. Windows&#8217;s <a href="http://msdn.microsoft.com/en-us/library/aa365531%28VS.85%29.aspx">SetEndOfFile</a> achieves the same result. <a href="http://lists.apple.com/archives/darwin-dev/2007/Dec/msg00040.html">Supposedly</a> OSX can do this via <a href="http://www.manpages.info/macosx/fcntl.2.html">fcntl</a>(F_PREALLOCATE), but does it?</p>

<p>I&#8217;ve experimented with posix_fadvise/SetEndOfFile and determined that they both change the file size and do their best to avoid fragmentation. Unfortunately I do not see any effect of fcntl(F_PREALLOCATE) on OS X 10.6 (the return code is successful). The file size does not change and if I then write to the file, it seems to fragment just as much as before. Can a Mac expert demonstrate that fcntl(F_PREALLOCATE) makes any difference at all?</p>

<p><strong>Update:</strong> Thanks a lot for the useful feedback, it was extremely helpful in producing this <a href="https://bug592520.bugzilla.mozilla.org/attachment.cgi?id=474233">patch</a>. It appears that the posix_fallocate equivalent is to the fnctl followed by a truncate() call (which actually forces data to be written to the file).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/07/fighting-fragmentation-sqlite/">Fighting Fragmentation: SQLite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-07T02:57:56-07:00" pubdate data-updated="true">Sep 7<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Thanks for all of those who commented on <a href="http://taras.glek.net/blog/2010/07/22/file-fragmentation/">previous post</a> on fragmentation. My first fragmentation <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=581606">fix</a> has landed. In current nightlies and future releases the main Firefox databases will grow more aggressively to avoid fragmentation. This should translate into better history/awesomebar/cookie performance for our most dedicated users.</p>

<p>Unfortunately fixing existing profiles is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592678">hard</a> from within Firefox. In the meantime advanced users on non-Windows platforms who are suffering from fragmentation can manually copy *.sqlite files to another directory and back.</p>

<p><strong>Windows: Ahead of the pack</strong></p>

<p>Evidence suggests that the Windows fragmentation situation is slightly better than on other platforms. Firefox fragmentation behavior on Windows is similar to other OSes but Windows periodically defragments Firefox files opened on startup. So one ends up with a cycle of deteriorating performance, followed by better performance(ie right after defrag), followed by deteriorating performance, etc.</p>

<p>I haven&#8217;t observed Windows defragmenting files for me, but it seems to do this for most users. Would love to learn more on how/when it decides to defragment files.</p>

<p><strong>Horror Stories </strong></p>

<p>I found a few other places that are horridly affected by fragmentation, will be blogging about those as I fix them. Fragmentation is an interesting problem to optimize because it affects dedicated users most, yet it is very tricky to replicate in a developer environment. Furthermore, there are a lot of misconceptions floating around:</p>

<ol>
<li>Fragmentation is a Windows problem that Linux is immune to due to having awesomer filesystems.</li>
<li>Mac OSX automatically defragments files, so fragmentation isn&#8217;t a problem there.</li>
<li>Fragmentation isn&#8217;t a problem on SSDs
To which I say:</li>
<li>Linux might be good at avoiding fragmentation for server workloads. It sucks for desktop users.</li>
<li>OSX will defragment small files, but big ones hurt most.</li>
<li>Cheap SSDs suck at tiny reads caused by fragmentation resulting in spectacularly bad IO. More on this in a future post.
To summarize: there are a lot of misleading stories floating around. I am always happy to hear more measurements/docs/bugs/etc on this subject, but I have zero patience for folk stories and speculation.</li>
</ol>


<p>I should also mention that the fragmentation problem isn&#8217;t limited to Firefox. Other browsers suffer from it too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/30/msvc-static-initializers-decent-stuff/">MSVC Static Initializers - Decent Stuff</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-30T05:56:17-07:00" pubdate data-updated="true">Jul 30<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was digging through a MSVC++ <a href="http://msdn.microsoft.com/en-us/library/k7xkk3e2%28v=VS.80%29.aspx">map file</a> for xul.dll. Turns out MSVC++ isn&#8217;t as <a href="http://taras.glek.net/blog/2010/05/27/startup-backward-constructors/">naive</a> about virtual initializers as the GNU toolchain. Initializers are all laid out next to each other. Same goes for what looks like finalizers and exception unwinding stuff. Initializers have an __E prefix and look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>0001:0089b470       ??__E?config@AvmCore@avmplus@@2UConfig@nanojit@@A@@YAXXZ 1089c470 f    CIL library: CIL module
</span><span class='line'>0001:0089b475       ??__EkStaticModules@@YAXXZ 1089c475 f   nsStaticXULComponents.obj
</span><span class='line'>0001:0089b638       ??__E?sSnifferEntries@nsUnknownDecoder@@1PAUnsSnifferEntry@1@A@@YAXXZ 1089c638 f   necko:nsUnknownDecoder.obj
</span></code></pre></td></tr></table></div></figure>


<p>Now if only Microsoft fixed their kernel to do [</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>memory-mapped IO</span></code></pre></td></tr></table></div></figure>


<p>](http://taras.glek.net/blog/2010/04/19/windows-sucks-at-memory-mapped-io-during-startup/) efficiently, it&#8217;d be a superior OS for starting Firefox.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/22/file-fragmentation/">File Fragmentation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-22T07:55:44-07:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Files are considered fragmented when they aren&#8217;t laid out in a continuous chunk on disk. This causes extra seeks even if the file is being read sequentially.</p>

<p>I was discussing startup over dinner, someone asked about how much of an issue fragmentation is in Firefox.</p>

<p>Early on I decided to pretend that fragmentation does not exist as we had bigger fish to fry. We were opening too many files on startup, effectively causing our own high-level fragmentation. Luckily, that problem should be mostly solved in Firefox 4 once <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=556644">omnijar</a> and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561842">fat xul</a> bugs land (unfortunately, extensions can cause similar issues until we stick em into a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=533038">single file</a>).</p>

<p>To measure fragmentation I used my SystemTap <a href="http://hg.mozilla.org/users/tglek_mozilla.com/startup/file/782c42e1d6a4/kernelio.stp">script</a> to get a list of files opened (one could also use strace or any similar tool) and piped the results to filefrag. Filefrag is a Linux fragmentation-measuring utility. On Windows one can use <a href="http://technet.microsoft.com/en-us/sysinternals/bb897428.aspx">contig</a> and Mac OS X features <a href="http://www.osxbook.com/software/hfsdebug/">hfsdebug</a>. I&#8217;m using ext4 on Linux.</p>

<p>My top offenders were:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>places.sqlite: 34 extents
</span><span class='line'>cookies.sqlite: 18 extents
</span><span class='line'>XPC.mfasl: 11 extents
</span><span class='line'>Cache/_CACHE_003_: 11 extents
</span><span class='line'>urlclassifier3.sqlite: 6 extents
</span><span class='line'>Cache/_CACHE_002_: 6 extents
</span><span class='line'>Cache/_CACHE_001_: 6 extents
</span><span class='line'>XUL.mfasl: 5 extents
</span><span class='line'>formhistory.sqlite: 5 extents
</span><span class='line'>content-prefs.sqlite: 4 extents
</span><span class='line'>libxul.so: 4 extents
</span><span class='line'>signons.sqlite: 3 extents
</span><span class='line'>icon-theme.cache: 2 extents
</span><span class='line'>libatk-1.0.so.0.2809.1: 2 extents
</span><span class='line'>libflashplayer.so: 2 extents
</span><span class='line'>Cache/_CACHE_MAP_: 2 extents
</span></code></pre></td></tr></table></div></figure>


<p>I did an informal poll of my friends and it seems that the order of fragmentation is similar among them, only the magnitude differs. For example, XFS tends to be 10-20 times more fragmented than ext4 :). I don&#8217;t have any numbers for HFS+, but I suspect XFS takes the crown as most fragmentation-prone filesystem to run Firefox.</p>

<p>Interestingly, my friend running NTFS reported similar fragmentation to ext4. That was disappointing as Windows Prefetch supposedly defragments files used with the first 10 seconds of startup. Clearly, isn&#8217;t keeping up in this case.</p>

<p><strong>Preliminary Conclusions</strong></p>

<p>places.sqlite is the largest and most performance-critical file in Firefox. It contains browser history and bookmarks. It is the brains behind the AwesomeBar.The fact that it is severely affected by fragmentation significantly impacts Firefox responsiveness. There are no easy fixes for fragmentation there. mak suggested moving history to a separate file to mitigate this, but that isn&#8217;t an easy change.</p>

<p>In contrast, cookies.sqlite is tiny(&lt;1mb for me) and probably so fragmented due to cookie expiration. I am guessing that easiest workaround here is to write a new sqlite file every time there is a mass update to the file.</p>

<p>urlclassifier.sqlite is a large file that may be mitigated similarly to cookies.</p>

<p><a href="http://www.sqlite.org/releaselog/3_7_0.html">SQLite 3.7.0</a> came out today which features WAL logging, which may reduce fragmentation (or make battling it easier). In general, sqlite&#8217;s VACUUM (used to clean and compact the database) command does not help with fragmentation, we really need to be doing something like hot backup which would create a new database file every VACUUM.</p>

<p>Our cache code is ancient and sucks. The cache files get fragmented immediately and severely. They are accessed in insane patterns and they get laid out insanely on disk. There are some efforts to improve the code, but I suspect that&#8217;s equivalent to putting <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=513008">lipstick</a> on a pig.</p>

<p>*.mfasl files are due to be obsoleted by a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=520309">startup cache</a> jar. It may get less fragmented. Should be a straight-forward fix it if it does get fragmented.</p>

<p>I&#8217;m disappointed to see the .so files get fragmented. This might be an ext4 bug or has something to do with how the updater works (both ours and yum on Fedora).</p>

<p><strong>Further Work</strong></p>

<p>I would like to see more data on fragmentation on Windows/OSX. Feel free to leave a comment with fragmentation numbers for cache, mfasl, sqlite and .dll files in your Firefox. We should look into online <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=556326">defragmentation API</a>s in modern OSes.</p>

<p><strong>Workarounds?</strong></p>

<p>Easiest way to fix fragmented files is to make a copy of the original file, delete the original and then rename the copy. This works on sane filesystems, apparently it doesn&#8217;t work too well on OS X.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/11/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/9/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/">Snappy #44: Fixing tab switching in Vancouver</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/05/snappy-43-big-improvements-faster-startup-smoother-tabstrip/">Snappy #43: Big improvements: faster startup? Smoother tabstrip!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/26/snappy-42/">Snappy #42</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/18/snappy-41/">Snappy #41</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Taras Glek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
