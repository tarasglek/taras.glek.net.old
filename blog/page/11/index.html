
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="Internet as of late have been obsessing over magically short patches that improve performance _ times(probably as a result of LKML cgroups patch from &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/page/11/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  
  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" title="subscribe via RSS">All RSS</a></li>
  
  <li><a href="/mozilla.xml" title="subscribe via RSS">Mozilla RSS</a></li>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

<script>
if (!window.requestAnimationFrame) {
  window.requestAnimationFrame = window.mozRequestAnimationFrame
    || window.webkitRequestAnimationFrame
    || window.msRequestAnimationFrame;

  window.cancelAnimationFrame = window.mozCancelAnimationFrame
    || window.webkitCancelAnimationFrame
    || window.msCancelAnimationFrame;

}

window._refreshLog = []
function refreshLogCounter() {
  window._refreshLog.push(Date.now())
  window._refreshLogCounter = requestAnimationFrame(refreshLogCounter);
}

window._refreshLogCounter = requestAnimationFrame(refreshLogCounter);
</script>

</nav>
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/02/09/magic-patch-that-doubles-windows-startup/">Magic Patch That Halves Windows Startup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-09T08:38:38-08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Internet as of late have been obsessing over magically short patches that improve performance _ times(probably as a result of LKML cgroups patch from a few weeks ago). So my work in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=627591">bug 627591</a> got picked up in all kinds of news sources(mostly due to @limi&#8217;s <a href="http://twitter.com/#!/limi/status/28983240966541312">manlove</a>). Apparently all that internet fame is good for is getting script-kiddies to upload viruses as bugzilla attachments. Dear Internet, please do not interrupt me in the middle of an investigation.</p>

<p>To crux of the optimization lies in trading waiting for random io for fast sequential IO. Turned out that my patch worked great if windows prefetch wasn&#8217;t trying to help (ie firefox ran faster without prefetch on my test systems). With prefetch on, the patch was either a smaller win or a downright loss. When I dug in deeper, it turned that the Windows Prefetch helpfully spends 3-6 seconds doing IO before any Firefox code gets to run. It also doesn&#8217;t read in a very clever pattern, resulting in a very small speed up for Firefox, but preventing my exciting optimization.</p>

<p>So I curled up into my defeated fetal position and pondered on how would I prevent Windows Prefetch from being so &#8220;helpful&#8221;. One way would be to <a href="http://taras.glek.net/blog/2010/10/04/diagnosing-slow-startup/">install</a> some crapware to cripple prefetch (kidding!), another way is to do the sequential IO in a separate executable(ala<a href="http://glandium.org/blog/?p=1719"> run-mozilla.sh</a> on Unix). This way Windows doesn&#8217;t try to do insane amounts of IO before my preloading logic gets to run. This seems to work (see wrapper.exe talk in the bug) and has potential to double Firefox startup times. It&#8217;s also ugly as sin, but if that&#8217;s what it takes&#8230;</p>

<p>So now I need more reports to make sure the executable wrapper approach reliably/significantly speeds up cold(post-reboot) startup. Then we can make a decision on how to integrate this into Firefox. But until we have all the data, please don&#8217;t jump to conclusions on what will and wont make Firefox 2x faster.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/14/builtin-startup-measurement/">Builtin Startup Measurement</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-14T05:25:20-08:00" pubdate data-updated="true">Jan 14<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I got used to measuring startup the complicated way (example <a href="http://taras.glek.net/blog/2010/01/04/windows-7-startup-exploration/">here</a>). It&#8217;s complicated enough that many people prefer to use stopwatches.</p>

<p>Turns out modern operating systems can help applications self-diagnose startup speed. Thanks to landing <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=522375">bug 522375</a> we now provide an API for measuring startup speed. For example, now I know that xpcshell takes forever to startup on mac</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>./xpcshell -e 'print(new Date() - Components.classes["@mozilla.org/toolkit/app-startup;1"].getService(Components.interfaces.nsIAppStartup_MOZILLA_2_0).getStartupInfo().process)'
</span></code></pre></td></tr></table></div></figure>


<p>At any point one can now go to the error console and type in</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>uneval(Components.classes["@mozilla.org/toolkit/app-startup;1"].getService(Components.interfaces.nsIAppStartup_MOZILLA_2_0).getStartupInfo())
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>var si=Components.classes["@mozilla.org/toolkit/app-startup;1"].getService(Components.interfaces.nsIAppStartup_MOZILLA_2_0).getStartupInfo(); si.sessionRestored-si.process
</span></code></pre></td></tr></table></div></figure>


<p>to get various interesting timestamps. So next time you see a startup take a surprising amount of time, you can go and poke around to see where that time was spent. At the moment there are 4 datapoints:</p>

<ol>
<li>.process - Process creation timestamp. This is cool because this happens before any library code is executed.</li>
<li>.main - XRE_main timestamp. My favourite thing to do is to subtract .process from .main. This demonstrates huge overheads that many application programmers refuse to believe in.</li>
<li>.firstPaint - Timestamp of the first intended paint. This coincides with when the user sees the first sign of life.</li>
<li>.sessionRestore - Timestamp of session restore, ie when the browser becomes useful.
Lots of people helped in getting this feature landed, but two people stand out. Daniel Brooks originally figured how to expose Windows/Linux startup speed in Mozilla. Mike Hommey devised a morally-reprehensible way to get precise startup speed out of the idiotic way that Linux presents it.</li>
</ol>


<p><strong>Linux Sucks </strong></p>

<p>Mac and Windows expose process creation times via human time. It&#8217;s just like any other API with time in it. Linux provides process startup speed in imbecile jiffies-since-boot. That&#8217;d be irritating enough, but to piss people off further there is no way to convert that into human time. Clever ps developers resort to calculating jiffies/second by comparing against seconds-since-start in /proc/uptime. Unfortunately that does not even come close to providing anything close to millisecond resolution needed for useful numbers. Mike&#8217;s idea of timing startup of another thread/task to get a known jiffy-stamp got us precise-enough numbers (around 10ms resolution with most kernels, see <a href="http://hg.mozilla.org/mozilla-central/rev/dfdf3e5dc749">patch</a> for details). At least Linus was kind enough to let mere user-space devs obtain the current tick-rate.</p>

<p><strong>Update:</strong></p>

<p>Linux doesn&#8217;t suck anymore, a commenter pointed me to a relatively new(2006) taskstats interface which appears to work sanely like the BSD one.</p>

<p>Mike Hommey made an <a href="http://glandium.org/blog/?p=1575">about:startup extension</a> using this API.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/29/faster-plugin-enumeration-help-wanted/">Faster Plugin Enumeration + Help Wanted</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-29T09:08:47-08:00" pubdate data-updated="true">Dec 29<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In addition to slow <a href="http://taras.glek.net/blog/">font enumeration</a>, we were suffering from a similar problem: slow plugin enumeration. Just as with fonts, the plugin enumeration code is different on every platform. Unlike the font situation, plugin enumeration is done completely within our code(ie easy to fix).</p>

<p>Plugin enumeration is often triggered by JavaScript code (for example by checking if a Java handler is present). This means that enumeration is a blocking operation that must happen quickly. XPerf made me wonder why so many plugin-like .dll files were being read. This lead me to a fun set of perf fixes.</p>

<p><strong>The Algorithm</strong></p>

<ol>
<li>Files in plugin directories are listed</li>
<li>Platform-specific IsPluginFile function to determines what files look like plugins(ie np*.dll on Windows).</li>
<li>Code then checks if the files + their timestamps are known by pluginreg.dat. If so, cached info is used and the following steps are skipped</li>
<li>For each library-file that isn&#8217;t found in pluginreg.dat, we use platform-specific GetPluginInfo to load the library-file to see if it is indeed a valid plugin (and to see what mimetypes it handles/etc).</li>
<li>Valid plugins are recorded in pluginreg.dat.
This process took up to 3 seconds on a user&#8217;s computer. WTF? There were gotchas in almost every step of the way.</li>
<li>Windows directory listing code would request metadata for <em>every bloody file in the directory</em>. Which resulted in an easiest optimization ever: <a href="https://bug616256.bugzilla.mozilla.org/attachment.cgi?id=494795">pure code deletion</a>.</li>
<li>IsPluginFile on Windows/Mac sneakily did more than just check the filename. It also <a href="https://bugzilla.mozilla.org/attachment.cgi?id=494840&amp;action=edit">checked</a> if the file was loadable, which on Windows loaded the dll and all of the dependencies. Mac code was <a href="https://bugzilla.mozilla.org/attachment.cgi?id=499855&amp;action=edit">satisfied</a> with merely doing a little extra IO.</li>
<li>This part was right</li>
<li><h1>2 was easily fixed by moving file IO here.</h1></li>
<li>Files that failed the check in #4 were doomed to cause extra IO for all of eternity. Scott Greenlay fixed that by <a href="https://bugzilla.mozilla.org/attachment.cgi?id=496518&amp;action=edit">recording</a> invalid plugin-like files too.
This was a rare fix that resulted in seconds saved on crapware-loaded computers. Usually I have to count my progress in milliseconds :(</li>
</ol>


<p><strong>Help Wanted </strong></p>

<p>I have plans for vastly improving Firefox startup, but I need help to get there. If you enjoy beating under-performing code into submission and want to work for Mozilla, please send me your resume(taras at mozilla dot com). Example projects: a better performance testsuite (ie tracking IO, cpu instructions, etc), better infrastructure for profiling addons, optimizing away various CSS/XUL markup, etc. A low-level approach to solving problems is helpful, compiler/linker/kernel hackers are well-suited (but not required) for this.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/21/rude-surprise-startup-overhead-of-windows-font-apis/">Rude Surprise: Startup Overhead of Windows Font APIs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-21T05:33:14-08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine a typical Firefox user who starts their Windows computer in order to surf the web. First app they launch is Firefox 4. Turned out that on systems that support hardware-acceleration for 2D graphics, Firefox 4 takes minutes to startup. WTF? XPerf-aided investigation showed that, the Windows font enumeration code causes us to do 30x more disk IO (~300MB) than the rest of Firefox code.</p>

<p>In order to hardware accelerate Firefox, we switched from GDI to using DirectWrite for font stuffs. Apparently, DirectWrite is a wonderful api, but the implementation has some teething issues. DirectWrite opens a connection to the Font Service (and starts it if it isn&#8217;t already running), however if service fails to respond DirectWrite proceeds to enumerate all of the system fonts on the client-side. This isn&#8217;t cool for multiple reasons: a) it is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=602792">slow as hell</a> b) it causes Firefox to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=617266">run out of memory</a>(installing IE9 helps!) sooner.  This means that currently Firefox 4 starts up a lot slower than 3.6. <a href="http://blog.mozilla.org/nattokirai/">John Daggett</a> is busy working on a workaround by using older GDI APIs to enumerate fonts. Firefox is one of the first popular Windows applications to switch to DirectWrite, so we get to suffer the consequences.</p>

<p>Unfortunately it turns out that using Microsoft GDI APIs to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=600713">enumerate fonts</a> still causes a significant amount of disk IO (~30-60MB), John plans to fix that next.</p>

<p><strong>How Did We Miss This?</strong></p>

<p>This bug came from a fundamental difference of how developers and users start Firefox. A developer will restart Firefox a dozen times an hour. This means we rarely get to observe true cold startup. Our tests only measure warm startup (because most operating systems make it difficult to test cold startup). Windows is also incredibly slow to develop on, so a lot of us test in a virtual machine to speed things up and avoid rebooting the computer all the time. This also makes observing cold startup hard. Fortunately xperf makes IO much easier to observe. We should deploy xperf on our <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=609111">test infrastructure</a> as soon as possible.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/30/crapware-and-firefox/">Crapware and Firefox</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-30T03:14:20-08:00" pubdate data-updated="true">Nov 30<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I completely agree with <a href="http://weblogs.mozillazine.org/asa/archives/2010/11/why_do_they_think_th.html">Asa</a> that having unwanted crap forced upon the user is morally wrong. We should do a better job of undoing this kind of braindamage. In the meantime here is a brief rant on the parasitic underpinnings of crapware.</p>

<p>Until recently, I have been testing Firefox on my own installs of Windows. I had no idea how aggressive bundleware could be. Then I got this piece-of-crap i7 Acer laptop with Windows 7 (and relatively little crapware preinstalled) and tried to use it as my primary machine. Suddenly, I could reproduce a lot more &#8220;slow&#8221; scenarios. I even went further and tried installing common crapware known as AVG to reproduce more bugs.</p>

<p>Turns out almost every vendor tries to mix in crap into Firefox. Acer, Microsoft Office/Silverlight, Adobe flash/acrobat, Google, AVG, etc all added unwanted functionality to my Firefox. I marveled at all kinds of &#8220;helpful&#8221; functionality such as the wonderful ability to click on a link in a webpage and have Google chrome install without any warning that the webpage is about to execute a windows program. AVG adds a couple of extensions that make Firefox start up 0.5-4x slower.</p>

<p>So far I noticed 2 vectors of attack: plugins and extensions. Plugins are fun because those get added by registering bonus plugin directories. Plugin directories are usually just application directories that contain plugins. This means Firefox gets to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=614423">slowly</a> rummage through bonus application directories looking for what might be a plugin. Extensions are fun because unlike plugins (which affect most browsers on the computer), extensions are very browser-specific. Most extension crapware doesn&#8217;t yet support Chrome. Installing things like AVG retards Firefox performance while Chrome escapes unmolested.</p>

<p><a href="http://benjamin.smedbergs.us/blog/2010-11-29/software-integration-is-not-evil/">Benjamin</a>, I don&#8217;t think these software vendors are &#8220;doing exactly as we ask of them.&#8221;</p>

<p>Personally, I would like us to be a lot more aggressive about blacklisting ill-performing software. Ie we need to go above and beyond <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=476430">warning</a> users when crapware. I would like to to actively check performance of popular plugins/addons and ban them if they are substandard.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/23/of-linkers-and-avoiding-suck/">Of Linkers and Avoiding Suck</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-23T02:41:47-08:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There is a common fallacy that since linkers and compilers are written by really smart people, there aren&#8217;t any huge performance wins left in the toolchain. My theory is that the efficiency of any given codebase varies inversely with the number of people who tried to optimize it.</p>

<p>I have long complained of suboptimal binaries generated from our code. Modern profiling tools such as <a href="http://taras.glek.net/blog/2009/10/23/studying-library-io-systemtap-style/">systemtap</a> and <a href="http://taras.glek.net/blog/2010/04/07/icegrind-valgrind-plugin-for-optimizing-cold-startup/">icegrind</a> made this painfully obvious. Mike Hommey opted for actually doing something about it. What started as a simple ld.so hack grew into a<a href="http://glandium.org/blog/?p=1177"> badass binary-rewriting tool</a> (and the most interesting blog post I&#8217;ve read this year).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/16/performance-progress/">Performance Update. Fragmentation: Mostly Fixed. GCC: Work-in-progress.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-16T07:14:02-08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Fragmentation: SQLite &amp; Friends </strong></p>

<p>I am happy to report that the SQLite fragmentation <a href="http://taras.glek.net/blog/2010/09/07/fighting-fragmentation-sqlite/">problem</a> is now <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=581606">solved</a>. I copied my profile a month ago, and my places.sqlite is still in a single fragment! There was a similar <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592520">fix</a> done to Firefox disk cache. Thanks to helpful comments on my OSX preallocation <a href="http://taras.glek.net/blog/2010/09/09/help-wanted-does-fcntlf_preallocate-work-as-advertised-on-osx/">cry for help</a>, we now preallocate efficiently on OSX too.</p>

<p>Startup cache is the last <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=593349">remaining</a> bastion of fragmentation, but that&#8217;s already 10x better than it was a month ago. I have two complimentary solutions for that: either <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562406">omnijar startup cache generation</a> for core code and/or write the cache more <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586859">efficiently</a>.</p>

<p>Firefox 4 will be a lot more gentle on those spinning platters.</p>

<p><strong>GCC</strong></p>

<p>I helped Jan Hubicka on a GCC <a href="http://gcc.gnu.org/wiki/summit2010">summit paper</a>. Those nasty static initializers will not be a hassle in GCC 4.6!</p>

<p>I keep wanting to blog about how we switched to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=559964">GCC 4.5</a> and how life is wonderful, but life didn&#8217;t work out this way. So far we tried switching away from 4.3 compiler three times. The first time GCC completely failed in terms of -Os performance. C++ -Os is more bloated in 4.5 (because that option is benchmarked on C apps). Then it turned out that libffi was being <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=45623">miscompiled</a> (we also found a related bug in libffi). Last time, we tried switching to GCC 4.5 + -O3 since that performs much better than -Os, but that <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=609543#c45">broke</a> sunspider. Hopefully we can fix the sunspider issue and try again next week. I would really like to utilize GCC <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=418866">PGO</a> to produce fastest possible Linux Firefox builds.</p>

<p>Nonetheless I happy with recent GCC progress. With Jan&#8217;s help, GCC will eventually be very good at compiling Mozilla. In my spare cycles I&#8217;ve been working on setting up GCC benchmarks using Mozilla to help avoid future surprises like we discovered in GCC 4.5. More on this later.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/10/04/diagnosing-slow-startup/">Diagnosing Slow Startup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-04T10:30:56-07:00" pubdate data-updated="true">Oct 4<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I spent last week trying to reproduce slow startup on Windows. Some users were reporting >30 second startup, supernova_00 has been feeding me <a href="https://developer.mozilla.org/En/Profiling_with_Xperf">xperf</a> traces on IRC reproducing slow startups.</p>

<p><strong>Startup Bugs</strong></p>

<p>Turns out that if a website uses non-standard font names this can trigger Firefox to start parsing every single font on the system, freezing the browser in the meantime. Turns out facebook does this :(. This is now a blocker <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=600713">bug 600713</a>. This bug has the unfortunate effect of overshadowing any startup improvements in Firefox 4.</p>

<p>We have some code to keep our databases in good shape by VACUUMing them. This is getting revamped in Firefox in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=541373">bug 541373</a>. In the meantime, for many current users performance suffers due to missing vacuums. If you are suffering from slow Firefox startup, and/or slow Awesomebar try this <a href="http://mozillalinks.org/wp/2009/08/vacuum-firefox-databases-for-better-performance-now-with-no-restart/">manual vacuum</a>. This helps in older Firefox releases, but in Firefox 4 this has the effect of supercharging the SQLite database performance by switching to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=416330">32K pages</a>.</p>

<p><strong>Scareware</strong></p>

<p>Another fun discovery was the effect of anti-virus software(AVG in this case). Like an annoying pet, AVG has to have a sniff and fondle every file that Firefox opens on startup. Apparently this is a feature called on-demand scanning, yuck.</p>

<p>But the fun doesn&#8217;t stop there, Windows has a wonderful <a href="http://en.wikipedia.org/wiki/Prefetcher">prefetch</a> mechanism that speeds up app startup. Unfortunately for supernova_00, \Windows\Prefetch just wouldn&#8217;t get populated with Firefox info, meaning that Windows wasn&#8217;t optimizing Firefox startup. Once I installed AVG, I ran into the same problem. Uninstalling AVG didn&#8217;t help. For whatever reason deleting every file in \Windows\Prefetch fixes that problem. For both of us prefetch got repopulated after being cleaned.</p>

<p><strong>XPerf</strong></p>

<p>Microsoft XPerf makes trivial to optimize cold startup. None of the other OSes have precanned analyses showing how much each individual file access is contributing to slow startup.</p>

<p>If you have a startup problem, I&#8217;m much more likely to be able to reproduce it if the report comes with an xperf trace. To get xperf run the Microsoft Platform SDK <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=6b6c21d2-2006-4afa-9702-529fa782d63b&amp;displaylang=en">installer</a>, select &#8220;Windows Performance Toolkit&#8221;.</p>

<p>To record an IO trace:</p>

<ol>
<li>Reboot</li>
<li>run cmd.exe as Administrator</li>
<li>xperf -on latency+FILE_IO+FILE_IO_INIT+DISK_IO</li>
<li>run Firefox, reproduce the bug</li>
<li>xperf -d report.etl</li>
<li>Run xperf report.etl to view the report.
Click on &#8220;IO Counts&#8221; or &#8220;Hard faults&#8221; graph, select &#8220;Summary Table&#8221;. &#8220;IO Time (ms)&#8221; is the interesting column there. To get an idea of the sequence of IO operations, export the summary table to .csv and load it in a spreadsheet/grep/whatever. Every Firefox developer should give xperf a try, addon authors are encouraged too.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/14/firefox-4-jar-jar-jar/">Firefox 4: Jar Jar Jar</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-14T03:32:35-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Opening files is relatively expensive. There is a small syscall overhead and a higher overhead of fetching data from disk. Depending on physical data layout and disk type, this can leave modern CPUs twiddling their thumbs for a long time while the disk skips around fetching all of the different file pieces.</p>

<p><strong>Optimization #1: Fewer naked files</strong></p>

<p>About two years ago I started gathering naked files on disk and shoving them into jars (eg <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=508421">bug 508421</a>). We made jar reading as efficient as possible by cleaning up code and switching to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=504864">mmap</a>. Eventually all application data files read from disk during &#8220;normal&#8221; startup ended up in jars. Unfortunately we ended up with four jars (toolkit, chrome + 2 locale jars), which felt silly. Due to limitations in XPCOM, a lot of naked files were still read from disk on version upgrades and extension installation.</p>

<p><strong>Optimization #2: One jar to rule them all</strong></p>

<p>Recently Michael Wu unleashed a can of <a href="http://blog.mozilla.org/mwu/2010/08/13/omnijar-how-does-it-work/">omnijar</a> whoopass. This was a massive effort driven by Android packaging requirements. Now application startup data is always being read from one file. This implies better data locality, less seeking, less waiting. One benefit of packing files tightly is that the OS speculatively reads data from disk in chunks that are usually larger than what the application requests. This makes reading nearby files free. Unfortunately there was no good way to predict the order that files will be accessed in without actually running Firefox, so there was more room for improvement.</p>

<p><strong>Optimization #3: Optimized jar layout </strong></p>

<p>So now that all of our data was in one file, the next logical step was to pack it intelligently. The only way to do this is to profile Firefox startup and then order the jar according to that. Unfortunately even once one lays out all of the jar entries sequentially we were still doing our io suboptimally. This was due to the fact that the zip index (jars are zip files) is traditionally located on the end of the file. Wikipedia <a href="http://en.wikipedia.org/wiki/ZIP_(file_format">entry</a>) has pictures to illustrate this.</p>

<p>In order to maximize readahead benefits and minimize disk seeks it would be nice to have the file index in the front of the file. So I changed our zip layout from</p>

<p><entry1><entry2>&#8230;<entryN><central directory><end of central directory></p>

<p>to</p>

<p><offset of the last entry read on startup><central directory><end of central directory><entry1><entry2>&#8230;<entryN><end of central directory></p>

<p>So all I did was change the offset in <end of central directory> to always be 4 (it can&#8217;t be 0 because anal zip programs balk at &#8220;NULL&#8221; central directory offsets). Then I added a second identical <end of central directory> entry to keep the the rule that the central directory is always followed by one. I also used the extra space forced upon me by overly vigilant zip programs to store a number indicating how much data we can preread on startup.</p>

<p>This yielded a 2-3x reduction in disk io over an unoptimized omnijar. This is on top of a >30-100x reduction achieved by going from naked files to omnijar.</p>

<p>The downside of my interpretation of the zip spec is that some zip programs expect zip files to be more rigid than the spec allows. Older versions of Firefox, Microsoft zip support in windows, WinRAR, unix zip programs, etc accept my optimized jars. 7zip, broken antivirus (it&#8217;s a security risk to be overly picky) <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=595473">fail</a>.</p>

<p>Trivia: this isn&#8217;t the first time we got tripped up by picky zip reading code. For example, the Android apk reader irritatingly insists at having a zip entry at byte zero of an Android package. This means that one can&#8217;t use apks to do the Android equivalent of self-extracting .exe files on Windows. Michael Wu is writing a custom library loader to deal with that :)</p>

<p><strong>Optimization #4: More Omnijar</strong></p>

<p>Feeling that omnijar wasn&#8217;t awesome enough, Michael Wu went ahead and <a href="http://blog.mozilla.org/mwu/2010/09/10/extensions-now-installed-packed/">omnijared extensions</a>. Most extensions will no longer need to be unpacked from xpi files. This also means that extension authors can opt to use the optimized jar format above to further speed up Firefox startup.</p>

<p><strong>Other jar optimizations</strong></p>

<p>Switching to jars via<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=520309"> startup cache</a> will allow us to further <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562406">optimize</a> our first startup. There is option of halving our jar IO further by actually making use of that readahead integer I added to optimized jars.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/09/help-wanted-does-fcntlf_preallocate-work-as-advertised-on-osx/">Help Wanted: Does fcntl(F_PREALLOCATE) Work as Advertised on OSX?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-09T07:06:11-07:00" pubdate data-updated="true">Sep 9<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To fight fragmentation it is best to tell the OS to allocate a continuous chunk of space for your file. With specialized APIs, the OS can do this without performing any IO (not counting metadata). I am adding support for this as part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592520">bug 592520</a>.  Linux features <a href="http://linux.die.net/man/3/posix_fallocate">posix_fadvise</a> for preallocating files. Windows&#8217;s <a href="http://msdn.microsoft.com/en-us/library/aa365531%28VS.85%29.aspx">SetEndOfFile</a> achieves the same result. <a href="http://lists.apple.com/archives/darwin-dev/2007/Dec/msg00040.html">Supposedly</a> OSX can do this via <a href="http://www.manpages.info/macosx/fcntl.2.html">fcntl</a>(F_PREALLOCATE), but does it?</p>

<p>I&#8217;ve experimented with posix_fadvise/SetEndOfFile and determined that they both change the file size and do their best to avoid fragmentation. Unfortunately I do not see any effect of fcntl(F_PREALLOCATE) on OS X 10.6 (the return code is successful). The file size does not change and if I then write to the file, it seems to fragment just as much as before. Can a Mac expert demonstrate that fcntl(F_PREALLOCATE) makes any difference at all?</p>

<p><strong>Update:</strong> Thanks a lot for the useful feedback, it was extremely helpful in producing this <a href="https://bug592520.bugzilla.mozilla.org/attachment.cgi?id=474233">patch</a>. It appears that the posix_fallocate equivalent is to the fnctl followed by a truncate() call (which actually forces data to be written to the file).</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/12/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/10/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/10/snappy-number-48-now-with-faster-shutdown/">Snappy #48: Now With Faster Shutdown</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/04/snappy-2012-summary/">Snappy: 2012 Summary</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/24/making-pages-load-faster/">Making pages load faster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/21/interesting-bugzilla-activity/">Snappy #45: The view from home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-octopress/">Hello Octopress</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
<script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p><h6>
  Copyright &copy; 2013 - Taras Glek - content on this site is licensed under the
Creative Commons Attribution Share-Alike License v3.0 or any later version.

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span></h6>
</p>
<script>
//indicate that content has been loaded
window._monitorContentLoaded = Date.now()
</script>
<script src="http://monitor-taras-glek-net.appspot.com/static/monitor.js">
</script>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
