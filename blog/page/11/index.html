
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="To fight fragmentation it is best to tell the OS to allocate a continuous chunk of space for your file. With specialized APIs, the OS can do this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/page/11/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">All RSS</a></li>
  
  <li><a href="/blog/categories/mozilla/atom.xml" rel="subscribe-rss" title="subscribe via RSS">Mozilla RSS</a></li>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/09/help-wanted-does-fcntlf_preallocate-work-as-advertised-on-osx/">Help Wanted: Does fcntl(F_PREALLOCATE) Work as Advertised on OSX?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-09T07:06:11-07:00" pubdate data-updated="true">Sep 9<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To fight fragmentation it is best to tell the OS to allocate a continuous chunk of space for your file. With specialized APIs, the OS can do this without performing any IO (not counting metadata). I am adding support for this as part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592520">bug 592520</a>.  Linux features <a href="http://linux.die.net/man/3/posix_fallocate">posix_fadvise</a> for preallocating files. Windows&#8217;s <a href="http://msdn.microsoft.com/en-us/library/aa365531%28VS.85%29.aspx">SetEndOfFile</a> achieves the same result. <a href="http://lists.apple.com/archives/darwin-dev/2007/Dec/msg00040.html">Supposedly</a> OSX can do this via <a href="http://www.manpages.info/macosx/fcntl.2.html">fcntl</a>(F_PREALLOCATE), but does it?</p>

<p>I&#8217;ve experimented with posix_fadvise/SetEndOfFile and determined that they both change the file size and do their best to avoid fragmentation. Unfortunately I do not see any effect of fcntl(F_PREALLOCATE) on OS X 10.6 (the return code is successful). The file size does not change and if I then write to the file, it seems to fragment just as much as before. Can a Mac expert demonstrate that fcntl(F_PREALLOCATE) makes any difference at all?</p>

<p><strong>Update:</strong> Thanks a lot for the useful feedback, it was extremely helpful in producing this <a href="https://bug592520.bugzilla.mozilla.org/attachment.cgi?id=474233">patch</a>. It appears that the posix_fallocate equivalent is to the fnctl followed by a truncate() call (which actually forces data to be written to the file).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/09/07/fighting-fragmentation-sqlite/">Fighting Fragmentation: SQLite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-07T02:57:56-07:00" pubdate data-updated="true">Sep 7<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Thanks for all of those who commented on <a href="http://taras.glek.net/blog/2010/07/22/file-fragmentation/">previous post</a> on fragmentation. My first fragmentation <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=581606">fix</a> has landed. In current nightlies and future releases the main Firefox databases will grow more aggressively to avoid fragmentation. This should translate into better history/awesomebar/cookie performance for our most dedicated users.</p>

<p>Unfortunately fixing existing profiles is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592678">hard</a> from within Firefox. In the meantime advanced users on non-Windows platforms who are suffering from fragmentation can manually copy *.sqlite files to another directory and back.</p>

<p><strong>Windows: Ahead of the pack</strong></p>

<p>Evidence suggests that the Windows fragmentation situation is slightly better than on other platforms. Firefox fragmentation behavior on Windows is similar to other OSes but Windows periodically defragments Firefox files opened on startup. So one ends up with a cycle of deteriorating performance, followed by better performance(ie right after defrag), followed by deteriorating performance, etc.</p>

<p>I haven&#8217;t observed Windows defragmenting files for me, but it seems to do this for most users. Would love to learn more on how/when it decides to defragment files.</p>

<p><strong>Horror Stories </strong></p>

<p>I found a few other places that are horridly affected by fragmentation, will be blogging about those as I fix them. Fragmentation is an interesting problem to optimize because it affects dedicated users most, yet it is very tricky to replicate in a developer environment. Furthermore, there are a lot of misconceptions floating around:</p>

<ol>
<li>Fragmentation is a Windows problem that Linux is immune to due to having awesomer filesystems.</li>
<li>Mac OSX automatically defragments files, so fragmentation isn&#8217;t a problem there.</li>
<li>Fragmentation isn&#8217;t a problem on SSDs
To which I say:</li>
<li>Linux might be good at avoiding fragmentation for server workloads. It sucks for desktop users.</li>
<li>OSX will defragment small files, but big ones hurt most.</li>
<li>Cheap SSDs suck at tiny reads caused by fragmentation resulting in spectacularly bad IO. More on this in a future post.
To summarize: there are a lot of misleading stories floating around. I am always happy to hear more measurements/docs/bugs/etc on this subject, but I have zero patience for folk stories and speculation.</li>
</ol>


<p>I should also mention that the fragmentation problem isn&#8217;t limited to Firefox. Other browsers suffer from it too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/30/msvc-static-initializers-decent-stuff/">MSVC Static Initializers - Decent Stuff</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-30T05:56:17-07:00" pubdate data-updated="true">Jul 30<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was digging through a MSVC++ <a href="http://msdn.microsoft.com/en-us/library/k7xkk3e2%28v=VS.80%29.aspx">map file</a> for xul.dll. Turns out MSVC++ isn&#8217;t as <a href="http://taras.glek.net/blog/2010/05/27/startup-backward-constructors/">naive</a> about virtual initializers as the GNU toolchain. Initializers are all laid out next to each other. Same goes for what looks like finalizers and exception unwinding stuff. Initializers have an __E prefix and look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>0001:0089b470       ??__E?config@AvmCore@avmplus@@2UConfig@nanojit@@A@@YAXXZ 1089c470 f    CIL library: CIL module
</span><span class='line'>0001:0089b475       ??__EkStaticModules@@YAXXZ 1089c475 f   nsStaticXULComponents.obj
</span><span class='line'>0001:0089b638       ??__E?sSnifferEntries@nsUnknownDecoder@@1PAUnsSnifferEntry@1@A@@YAXXZ 1089c638 f   necko:nsUnknownDecoder.obj
</span></code></pre></td></tr></table></div></figure>


<p>Now if only Microsoft fixed their kernel to do [</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>memory-mapped IO</span></code></pre></td></tr></table></div></figure>


<p>](http://taras.glek.net/blog/2010/04/19/windows-sucks-at-memory-mapped-io-during-startup/) efficiently, it&#8217;d be a superior OS for starting Firefox.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/22/file-fragmentation/">File Fragmentation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-22T07:55:44-07:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Files are considered fragmented when they aren&#8217;t laid out in a continuous chunk on disk. This causes extra seeks even if the file is being read sequentially.</p>

<p>I was discussing startup over dinner, someone asked about how much of an issue fragmentation is in Firefox.</p>

<p>Early on I decided to pretend that fragmentation does not exist as we had bigger fish to fry. We were opening too many files on startup, effectively causing our own high-level fragmentation. Luckily, that problem should be mostly solved in Firefox 4 once <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=556644">omnijar</a> and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561842">fat xul</a> bugs land (unfortunately, extensions can cause similar issues until we stick em into a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=533038">single file</a>).</p>

<p>To measure fragmentation I used my SystemTap <a href="http://hg.mozilla.org/users/tglek_mozilla.com/startup/file/782c42e1d6a4/kernelio.stp">script</a> to get a list of files opened (one could also use strace or any similar tool) and piped the results to filefrag. Filefrag is a Linux fragmentation-measuring utility. On Windows one can use <a href="http://technet.microsoft.com/en-us/sysinternals/bb897428.aspx">contig</a> and Mac OS X features <a href="http://www.osxbook.com/software/hfsdebug/">hfsdebug</a>. I&#8217;m using ext4 on Linux.</p>

<p>My top offenders were:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>places.sqlite: 34 extents
</span><span class='line'>cookies.sqlite: 18 extents
</span><span class='line'>XPC.mfasl: 11 extents
</span><span class='line'>Cache/_CACHE_003_: 11 extents
</span><span class='line'>urlclassifier3.sqlite: 6 extents
</span><span class='line'>Cache/_CACHE_002_: 6 extents
</span><span class='line'>Cache/_CACHE_001_: 6 extents
</span><span class='line'>XUL.mfasl: 5 extents
</span><span class='line'>formhistory.sqlite: 5 extents
</span><span class='line'>content-prefs.sqlite: 4 extents
</span><span class='line'>libxul.so: 4 extents
</span><span class='line'>signons.sqlite: 3 extents
</span><span class='line'>icon-theme.cache: 2 extents
</span><span class='line'>libatk-1.0.so.0.2809.1: 2 extents
</span><span class='line'>libflashplayer.so: 2 extents
</span><span class='line'>Cache/_CACHE_MAP_: 2 extents
</span></code></pre></td></tr></table></div></figure>


<p>I did an informal poll of my friends and it seems that the order of fragmentation is similar among them, only the magnitude differs. For example, XFS tends to be 10-20 times more fragmented than ext4 :). I don&#8217;t have any numbers for HFS+, but I suspect XFS takes the crown as most fragmentation-prone filesystem to run Firefox.</p>

<p>Interestingly, my friend running NTFS reported similar fragmentation to ext4. That was disappointing as Windows Prefetch supposedly defragments files used with the first 10 seconds of startup. Clearly, isn&#8217;t keeping up in this case.</p>

<p><strong>Preliminary Conclusions</strong></p>

<p>places.sqlite is the largest and most performance-critical file in Firefox. It contains browser history and bookmarks. It is the brains behind the AwesomeBar.The fact that it is severely affected by fragmentation significantly impacts Firefox responsiveness. There are no easy fixes for fragmentation there. mak suggested moving history to a separate file to mitigate this, but that isn&#8217;t an easy change.</p>

<p>In contrast, cookies.sqlite is tiny(&lt;1mb for me) and probably so fragmented due to cookie expiration. I am guessing that easiest workaround here is to write a new sqlite file every time there is a mass update to the file.</p>

<p>urlclassifier.sqlite is a large file that may be mitigated similarly to cookies.</p>

<p><a href="http://www.sqlite.org/releaselog/3_7_0.html">SQLite 3.7.0</a> came out today which features WAL logging, which may reduce fragmentation (or make battling it easier). In general, sqlite&#8217;s VACUUM (used to clean and compact the database) command does not help with fragmentation, we really need to be doing something like hot backup which would create a new database file every VACUUM.</p>

<p>Our cache code is ancient and sucks. The cache files get fragmented immediately and severely. They are accessed in insane patterns and they get laid out insanely on disk. There are some efforts to improve the code, but I suspect that&#8217;s equivalent to putting <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=513008">lipstick</a> on a pig.</p>

<p>*.mfasl files are due to be obsoleted by a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=520309">startup cache</a> jar. It may get less fragmented. Should be a straight-forward fix it if it does get fragmented.</p>

<p>I&#8217;m disappointed to see the .so files get fragmented. This might be an ext4 bug or has something to do with how the updater works (both ours and yum on Fedora).</p>

<p><strong>Further Work</strong></p>

<p>I would like to see more data on fragmentation on Windows/OSX. Feel free to leave a comment with fragmentation numbers for cache, mfasl, sqlite and .dll files in your Firefox. We should look into online <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=556326">defragmentation API</a>s in modern OSes.</p>

<p><strong>Workarounds?</strong></p>

<p>Easiest way to fix fragmented files is to make a copy of the original file, delete the original and then rename the copy. This works on sane filesystems, apparently it doesn&#8217;t work too well on OS X.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/14/my-startup-summary/">My Startup Summary</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-14T04:27:13-07:00" pubdate data-updated="true">Jul 14<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I try to blog about interesting things I encounter while solving various issues in Mozilla. Some things are less bloggable than others. If this blog don&#8217;t fulfill your startup + static analysis needs you can follow my <a href="http://benjamin.smedbergs.us/weekly-updates.fcgi/user/tarasglek/posts">status</a> updates and <a href="http://twitter.com/crazyhackerdude">twitter</a>. For now here is a summary of various half-baked/inprogress work:</p>

<ul>
<li>I worked on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=559964">upgrading</a> to GCC 4.5 which turned out to be a performance regression. While tracking down a workaround, I got into helping GCC guys help us by fixing gcc trunk&#8217;s LTO to work on Mozilla.</li>
<li>I am also determined to see Firefox come out with a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561842">fat</a> libxul and not link to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=577522">useless</a> to us libraries by default.</li>
<li>I spent a lot of time figuring out why our sqlite io <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=572459">hurting</a>, ended up bumping block size to 32K. I am really hoping that Marco can <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=541373">deliver</a> VACUUM for all of the Firefox databases in time for Firefox 4.</li>
<li>I refactored most of icegrind so in addition optimizing startup, it can also facilitate investigative work like <a href="http://glandium.org/blog/?p=1016">Mike Hommey </a>is doing.</li>
<li>Posted a <a href="http://groups.google.com/group/mozilla.dev.platform/browse_thread/thread/abf60ad5fd03a708?pli=1">summary</a> on the evils of static initializers. Came across a Chrome <a href="http://comments.gmane.org/gmane.comp.web.chromium.devel/16789">equivalent</a> today.
I plan to blog more on each of these subjects as they get closer to realization.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/06/09/galois-talk/">Galois Talk</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-06-09T03:08:44-07:00" pubdate data-updated="true">Jun 9<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was invited to present a <a href="http://www.galois.com/blog/2010/06/03/tech-talk-large-scale-static-analysis-at-mozilla/">Galois tech talk</a> on Mozilla static analysis. It was really cool to give a talk locally to such an expert audience. I was surprised to discover a vibrant Programming Languages + Analysis community in Portland.</p>

<p>Edward Z. Yang did an <a href="http://blog.ezyang.com/2010/06/static-analysis-mozilla/">excellent write-up</a> on the talk.</p>

<p><strong>PLDi</strong></p>

<p>Robert O&#8217;Callahan mentioned Dehydra in his <a href="http://weblogs.mozillazine.org/roc/archives/2010/06/sleepless_in_to.html">PLDI talk</a>.</p>

<p><strong>Dehydra/Treehydra in GCC 4.5</strong></p>

<p>There a few fixes that are about to land. I&#8217;m hoping that by the end of the week GCC 4.5 support will be production-quality. Sorry that it&#8217;s taken so long, but I&#8217;ve been busy focusing on startup. <a href="http://ehren.wordpress.com/">Ehren</a> has picked up the slack, we should be able to produce a fairly polished Dehydra 1.0 by the end of the summer.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/27/startup-backward-constructors/">Startup: Backward Constructors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-27T09:35:20-07:00" pubdate data-updated="true">May 27<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post is a result of debugging <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561842">bug 561842</a>. Turns out one needs to go far beyond lumping libraries together to reap startup benefits.</em></p>

<p>I made a <a href="http://hg.mozilla.org/users/tglek_mozilla.com/startup/raw-file/ca994a12e2a8/xulanatomy.pdf">pdf</a> to illustrate the cost centers of loading libxul.so (the essence of Firefox).</p>

<p>With <a href="http://taras.glek.net/blog/2010/04/07/icegrind-valgrind-plugin-for-optimizing-cold-startup/">Icegrind</a> I demonstrated that better binary layout can significantly improve application startup. However I still didn&#8217;t have a breakdown of reasons of why loading binaries is so damn inefficient. That&#8217;s what the above pdf is about.</p>

<p>Loading libxul consists of 4 major phases:</p>

<ol>
<li>Runtime linker setup: mapping segments in, zeroing .bss, loading dependent libraries, etc</li>
<li>Runtime linker relocations.</li>
<li>Library intializers.</li>
<li>main() and the rest of application code runs
I blogged about 1, 2, 4, this post is about #3.</li>
</ol>


<p><strong>Library Initializers?</strong></p>

<p><a href="http://people.gnome.org/~michael/">Michael Meeks</a> pointed me at the funny backwards IO pattern in his IO logs. I even <a href="http://taras.glek.net/blog/2010/03/24/linux-why-loading-binaries-from-disk-sucks/">made fun</a> of how by default libxul.so is read mostly via backwards IO. Once I <a href="http://taras.glek.net/blog/2010/05/24/teethig-troubles-assigning-blame-for-pagefaults/">assigned</a> userspace symbols to my pagefault log, it became clear that the backwards IO pattern was entirely due to library initializers. C++ compiler generates code that runs on library initialization to initialize globals and run relevant C++ constructors. In C one can assign a &#8220;constructor&#8221; GNU attribute to a function to participate in this mayhem.</p>

<p><strong>Running Backwards?</strong></p>

<p>Ian Lance Taylor clued me in on why these things run backwards.When one links the program, the object files are laid out sequentially. Static libraries are specified after the code that depends on them. Once an object is linked, the easiest way to make sure that libraries are initialized before their users is to invoke initializers backwards. The list of initializers is stored in the .ctors section and they loaded by libgcc.</p>

<p>In Mozilla (and likely other C++ codebases) these global initializers are more or less evenly scattered throughout the codebase. By the time main() is run, most of the program has been paged in an unfortunately inefficient manner.</p>

<p><strong>Run Faster Please?</strong></p>

<p>The most interesting part about all this that the compiling toolchain can make a rather precise guess at how a large part of the initial program execution is going to go. To test this theory I wrote my best Mozilla <a href="https://bugzilla.mozilla.org/attachment.cgi?id=447253&amp;action=edit">patch</a> ever.</p>

<p>One can place a function near the beginning of the library file and another one at the end (with a &#8220;constructor&#8221; attribute). The function at the end runs first and it can figure out the approximate range of memory that will need to be paged in and madvise() it. This results in a 5x reduction in libxul pagefaults. Unfortunately since constructors execute backwards and readahead forwards, the constructor execution stalls to wait for readahead, so the speedup is rather hard to detect.</p>

<p><strong>Run Forward Faster!</strong></p>

<p>Depressed about my hack failing to make a dent in startup time I patched gcc to run initializers in a forward order (and reversed the function-placement logic in above patch). Now readahead happened in the same direction as library initialization and my Firefox started 30% faster! I wrapped this up into a standalone <a href="http://people.mozilla.com/~tglek/startup/ctors.diff">gcc patch</a> (speed up any bloated C++ startup with a simple change to the compiler!). Note this hack reverses the library initialization order discussed above, this happens to not be a problem for Mozilla.</p>

<p><strong>Conclusion: Order Matters! </strong></p>

<p>The linker can reverse the per-library initializers such that initializers run forward, but cross-library dependencies are honoured. That in itself isn&#8217;t enough to boost startup without cleverer readahead on the kernel side (or application-side hacks).</p>

<p>It&#8217;s weird to have initializers page in most of the binary. An interesting optimization would to have the compiler transitively mark functions reached by library initialization and place those in a .text.initializers section. Then one could have the linker group the initializers together.</p>

<p><strong>Plans</strong></p>

<p>I haven&#8217;t made up my mind on how to proceed. This madvise() hack + a simple linker patch could be deployed more easily than icegrind. This hack also appears to be as performant as a static firefox build + icegrind (due to inadequate kernel readahead without madvise()). Icegrid + libxul.so isn&#8217;t quite as efficient. I have a feeling that we&#8217;ll end up with a combination of icegrind + some form the initializer madvise() hack.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/24/teethig-troubles-assigning-blame-for-pagefaults/">Teething Troubles: Assigning Blame for Pagefaults</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-24T03:52:22-07:00" pubdate data-updated="true">May 24<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been able to get precise filed-backed page fault logging(systemtap on Linux, xperf on Windows) for a while. It is incredibly useful to see exactly how Firefox is being loaded from disk. From there one I deduce what is causing the IO, try to make improvements and measure if I accomplished anything.</p>

<p>Unfortunately, a mere IO log requires a lot of pondering of why IO is happening. It would be so much easier if one could just get a report of every IO operation + an application backtrace to easily identify the cause. I was having trouble figuring out why some of my optimizations were not having the impact I expected, so i embarked on adding a backtrace to my log.</p>

<p><strong>XPerf Fail</strong> I fed <a href="https://developer.mozilla.org/En/Profiling_with_Xperf">xperf</a> my Firefox symbols hoping this would plop stack traces next to my faults, but no such luck. It records backtraces in just about every probe, except for the &#8220;hard faults&#8221; probe I care about. I wonder if a custom perf probe could log what I want.</p>

<p><strong>Perf Fail</strong></p>

<p>Some prominent kernel hackers have long been complaining about OProfile/SystemTap/NIH performance monitoring tools. They finally produced a <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=tree;f=tools/perf;h=3f4245bfe10b67348c5cd41606f3fdc0396cbbea;hb=7e125f7b9cbfce4101191b8076d606c517a73066">perf</a> tool (It&#8217;s like they tried to make it hard to google for. It does not have a <a href="https://perf.wiki.kernel.org/index.php/Main_Page">proper</a> website; Real men read the source and skim LKML archives) to do profiling the Linux way(tm). I might be wrong, but so far it appears to be a functional equivalent of Microsoft&#8217;s xperf minus the nice UI.</p>

<p>Turned out that my Fedora 2.6.32 perf implementation is too buggy to even log pagefaults. Apparently this works in the current Linus kernels. I&#8217;m not completely sure, but looks like even if xperf pagefault logging worked, it&#8217;s pretty neutered. It does not appear that it can log file offsets next to pagefaults, nor stacks.</p>

<p>I think perf could be fixed to log io and accompanying userspace backtraces. There are some talented folks contributing to it. However I think that the pre-canned analysis model sucks. It is useful for building sophisticated versions of top, but when you really need to dig into what&#8217;s causing a particular issue, it really sucks to be restricted by what the developers foresaw as useful.</p>

<p><strong>SystemTap</strong></p>

<p>As awesome as the kernel side of <a href="http://sourceware.org/systemtap/">SystemTap</a> is, I keep running into userspace bugs and limitations. Getting userspace stacks for large collections of large libraries that Firefox relies on has been a systemtap-bug-finding affair. I can occasionally get useful userspace tracks for userspace probes, but apparently recording a userspace stack from a kernel probe is a hard problem that SystemTap devs haven&#8217;t fully addressed yet.</p>

<p>Luckily SystemTap provides a uaddr() function which appears to get correct addresses from my kernel probes(which is way more than the other tools offer). Unfortunately usymname() fails to resolve those addresses.</p>

<p>As a workaround, Jim Blandy suggested turning off <a href="http://gcc.gnu.org/wiki/Randomization">address-space randomization</a> so I can log uaddr() and resolve the values in gdb. I&#8217;ve been manually printing this with gdb&#8217;s &#8220;p/a <addr>&#8221; command until recently.</p>

<p><strong>Success?</strong></p>

<p>Then it dawned on me that I can use python gdb-scripting to automatically post-process the log. So now with a combination of a <a href="http://hg.mozilla.org/users/tglek_mozilla.com/startup/file/74e2f62fe64c/kernelio.stp">systemtap io logging script</a> and a hacky <a href="http://hg.mozilla.org/users/tglek_mozilla.com/startup/file/74e2f62fe64c/gdb_resolve.py">gdb python script</a> I can produce logs like <a href="http://people.mozilla.com/~tglek/startup/pagefault_blame.txt">this</a>.</p>

<p>I still don&#8217;t have backtraces, but at least now I have the name of the function that&#8217;s causing trouble. This is surprisingly useful already. One can now easily tell how much of startup is being wasted on relocations(dlopen() in a prelinked binary!). Another obvious one is the <a href="http://sourceware.org/bugzilla/show_bug.cgi?id=11618">harm</a> of single-page COW faults to zero .bss (memset entries in the log). Turns out <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=44236">sprinkling</a> initializers all over the binary is a bad idea. Looks like there are significant performance wins to be had with a bit of &#8216;easy&#8217; compiler/linker hacking.</p>

<p>All of the above problems are really obvious and would&#8217;ve been fixed a long time ago if it was easier to get at this information. Unfortunately, there is still a lot of room for improvement in developer tools<strong>.</strong></p>

<p><strong>Update:</strong></p>

<p>Sounds like I can use addr2line instead of gdb.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/04/20/mozillaservices/">Mozilla::services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-04-20T04:20:10-07:00" pubdate data-updated="true">Apr 20<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I landed the mozilla::services <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=516085">bug</a> around the same time as Gavin <a href="http://www.gavinsharp.com/blog/2010/02/25/services-jsm/">announced</a> the Services.jsm equivalent. Services.jsm came a pleasant surprise to me, it&#8217;s nice to have API symmetry.</p>

<p><a href="https://developer.mozilla.org/en/XPCOM/mozilla::services_namespace">mozilla::services</a> namespace provides a fast C++ way to refer to common services. This replaces a myriad layers of indirection that happened in the XPCOM <a href="https://developer.mozilla.org/en/XPCOM_Interface_Reference/nsIServiceManager/getService">GetService()</a> call. Too much generality hurts.</p>

<p>So far I only replaced the common IOService getters. URL objects are 30% less slow to create now. A contributor, Mitchell Field, has volunteered to switch over a huge amount of other common services in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=560095">bug 560095</a>. That rocks.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/04/19/windows-sucks-at-memory-mapped-io-during-startup/">Windows Sucks at Memory-Mapped IO During Startup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-04-19T07:00:00-07:00" pubdate data-updated="true">Apr 19<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week I learned about how Windows handles page faults backed by files (specifically xul.dll). I already knew that Linux was <a href="http://taras.glek.net/blog/2010/04/12/squeezing-every-last-bit-of-performance-out-of-the-linux-toolchain/">suboptimal</a> in this area, perhaps the clever people at Redmond did better.</p>

<p>Shaver pointed me at <a href="https://developer.mozilla.org/En/Profiling_with_Xperf">xperf</a>, which is sort of like the new Linux perf tools. Xperf rocks in that it can capture the relevant data and it can export it as .csv.</p>

<p>Even with profile-guided-optimization Windows causes 3x as much IO in xul.dll than linux does on libxul.so. That&#8217;s especially interesting given that xul.dll is one-third smaller on Windows. Here is the <a href="http://people.mozilla.com/~tglek/startup/systemtap_graphs/visualize.html?#../win7/noprefetch.csv.html">graph</a>. PGO isn&#8217;t helping on Windows as much as it can help on Linux because MSVC PGO doesn&#8217;t do the equivalent of GCC&#8217;s -freorder-blocks-and-partition (unless I missed something in the docs).</p>

<p>With the Windows <a href="http://en.wikipedia.org/wiki/Prefetcher">prefetcher</a>, there were 4x less xul.dll IOs (graph <a href="http://people.mozilla.com/~tglek/startup/systemtap_graphs/visualize.html?#../win7/prefetch.csv.html">here</a>). Unfortunately, the prefetcher can&#8217;t figure out that the whole xul.dll should be paged in and we still end up with an excess of random IO.</p>

<p><strong>Why?</strong></p>

<p>When a page fault occurs, Windows goes to read the page from the file and reads a little extra (just like any other sane OS) assuming that there will be more IO nearby. Unfortunately the gods of virtual memory at Microsoft decided that for every page fault, only 7 extra pages should read. So reads occur in 32K chunks (vs 128K in Linux, which is still too small). To make matters worse, segments mapped in as data only read in 3 extra pages (ie 16K chunks).</p>

<p>This is funny in a sad way. Reading in 32K chunks is supposed to minimize ram usage (which makes no bloody sense when Win7 officially requires 1GB of RAM). As a result of being so thrifty on easy-to-evict file cache, windows ends up doing 4x as much file IO as Linux. The 16K reads are particularly funny as one can see the result of that misoptimization in the string of puny reads on the top right of the graphs.</p>

<p><strong>Surely There is an API like madvise()</strong> On Posix systems madvise() can be used to influence the caching behavior of the OS. fadvise() is another such call for IO based on filehandles. For example, Firefox fastload files are now madvise()ed such that they are read in a single 2mb chunk on startup. Unfortunately, it appears that Windows has no such APIs so one is stuck with pathetically small reads.</p>

<p>At first, I thought that, passing FILE_FLAG_SEQUENTIAL_SCAN when opening the file handle will work like a crappy fadvise()-equivalent. Turns out that mmaping files completely bypasses the Windows Cache Manager, so that flag just gets ignored.</p>

<p>So as far as I can tell the only way to convince Windows to not read stuff in stupidly small chunks is to mmap() everything we care about using large pages. Unfortunately that comes with some significant costs.</p>

<p>We are going to try to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=553721">order</a> the binaries better which should halve the amount of page faults.</p>

<p><strong>Can Windows Do Anything Better?</strong></p>

<p>Yes. The &#8220;Unix way&#8221; of breaking up everything into a billion libraries and configuration files results in 10x more files being read on startup on Linux vs Windows. Just because Linux can read individual libraries 4x faster, doesn&#8217;t mean that IO becomes free.</p>

<p>Presently, in ideal conditions, Firefox starts up 30-50% faster on Windows. The Windows Prefetcher hack sweeps a lot of Windows suck under the carpet, but Microsoft has a lot of room for improvement.</p>

<p><strong>Update:</strong><br/>
People seem to prefer to comment on <a href="http://www.reddit.com/r/programming/comments/bu2do/windows_sucks_at_memorymapped_io_during_startup/">reddit</a>. If you want me to not miss your comment, make sure you comment here.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/12/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/10/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/21/interesting-bugzilla-activity/">Snappy #45: The view from home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/">Snappy #44: Fixing tab switching in Vancouver</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/05/snappy-43-big-improvements-faster-startup-smoother-tabstrip/">Snappy #43: Big improvements: faster startup? Smoother tabstrip!</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p><h6>
  Copyright &copy; 2012 - Taras Glek - content on this site is licensed under the
Creative Commons Attribution Share-Alike License v3.0 or any later version.

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span></h6>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
