
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="At 15 minutes, this might&#8217;ve been our shortest meeting yet (notes). Most of the work happened in frontend stuff. Most notable improvements are &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/page/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" title="subscribe via RSS">All RSS</a></li>
  
  <li><a href="/mozilla.xml" title="subscribe via RSS">Mozilla RSS</a></li>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

<script>
if (!window.requestAnimationFrame) {
  window.requestAnimationFrame = window.mozRequestAnimationFrame
    || window.webkitRequestAnimationFrame
    || window.msRequestAnimationFrame;

  window.cancelAnimationFrame = window.mozCancelAnimationFrame
    || window.webkitCancelAnimationFrame
    || window.msCancelAnimationFrame;

}

function refreshLogCounter() {
  if(!window._refreshLog) {
    window._refreshLog = [Date.now()]
    return
  }
  window._refreshLog.push(Date.now()-window._refreshLog[window._refreshLog.length-1].now())
  window._refreshLogCounter = requestAnimationFrame(refreshLogCounter);
}

window._refreshLogCounter = requestAnimationFrame(refreshLogCounter);

</script>

</nav>
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/19/snappy-april-19/">Snappy, April 19</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-19T07:47:40-07:00" pubdate data-updated="true">Apr 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At 15 minutes, this might&#8217;ve been our shortest meeting yet (<a href="https://wiki.mozilla.org/Performance/Snappy/2012-04-19">notes</a>).</p>

<p>Most of the work happened in <a href="https://wiki.mozilla.org/Performance/Snappy/2012-04-19#Front-end_-_Dietrich">frontend stuff</a>. Most notable improvements are reduced screenshot overhead (by taking less screenshots, bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744152">744152</a>) and a brand new IE migrator (a step towards fully async places API, bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=710895">710895</a>).</p>

<p>Work resumed on making peptest return more <a href="https://wiki.mozilla.org/Performance/Snappy/2012-04-19#peptest_-_mcote">consistent </a>results.</p>

<p>The necko team decided to take a more involved approach to solve our cache locking(bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=722034">722034</a>) which means the fix will land later than we originally hoped for.</p>

<p>My little investigation into setTimeout <a href="http://taras.glek.net/blog/2012/04/18/web-2-0-a-collection-of-settimeouts/">overhead</a> exposed more overhead than I expected. After our regularly scheduled snappy meeting, we had a follow up meeting to spec out how to change our event handling to cope with this (bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=715376">715376</a>). Our best people are on this :) I asked for someone to prototype an extension to suspend background tab activity, sounds like  Wladimir of adblockplus might lend a hand.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/18/web-2-0-a-collection-of-settimeouts/">Web 2.0: A Collection of SetTimeouts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-18T09:13:19-07:00" pubdate data-updated="true">Apr 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Earlier I <a href="http://taras.glek.net/blog/2012/04/10/argh-at-our-unresponsive-tab-strip-settimeoutfoo-0-can-be-very-harmful/">blogged </a>about terrible UI responsiveness resulting from a poorly placed setTimeout. I&#8217;ve long suspected that SetTimeouts are to blame for everything. Now with help of bz and sfink I have proof.</p>

<p>Turns out webpages like to keep users entertained and spin setTimeout loops to poll the servers to synchronize news tickers, social networking shoe-ins, collaborative editing, etc. Most pages do this regardless of whether they are a background or a foreground tab. Firefox tries to mitigate this by not allowing background tabs to schedule setTimeouts &lt; 2seconds. Turns out this is a pretty weak defense.</p>

<p>In my personal browsing: etherpad, twitter, zimbra burn through cpu cycles. See this bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744470#c12">comment </a>for an example of setTimeout terrorism with less than 10 tabs. In Firefox these setTimeouts cause significant UI lag, but they will also eat your battery life, overheat your laptop, etc. I filed bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=715376">715376</a> to add functionality to cope with this.  The plan is to prioritize foreground tab activity and do exponential setTimeout decay on abusive background tabs. We basically have to write something similar to an OS scheduler. Ideally we&#8217;d also follow that up with unloading idle tabs, ie bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=675539">675539</a>.</p>

<p>If you are curious about what tabs are abusing your browser my <a href="http://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/tglek@mozilla.com-520630fd738e">diagnostic builds</a> will be available on try in a few hours. Install a <a href="http://people.mozilla.com/~tglek/telemetry/ping.telemetry.xpi">modified </a>version of about:telemetry to see the report.</p>

<p><strong>What should well-behaved web apps do?</strong></p>

<p>You can detect when your tab becomes inactive via <a href="https://developer.mozilla.org/en/DOM/window.onblur">window.onblur</a>, then throttle or disable your page activity. I know using focus is suboptional for this. There is also a vendor-prefixed <a href="https://developer.mozilla.org/en/API/PageVisibility/Page_Visibility_API">visibility api</a> (thanks!).</p>

<p>Now you know why your browser keeps your CPU wide awake :)</p>

<p><em>Update:</em></p>

<p>Wrote this post in a rush on the way out, thanks for the visibility links. I am aware that some webpages need to do work in the background. However that work should be as minimal as possible, this is often not the case.</p>

<p><em>Project Idea:</em></p>

<p>Would be nice if someone wrote an extension that goes through tabs and nukes any outstanding setTimeouts/XHRs/etc.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/16/snappy-april-12/">Snappy, April 12</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-16T06:45:17-07:00" pubdate data-updated="true">Apr 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Notes are<a href="https://wiki.mozilla.org/Performance/Snappy/2012-04-12"> here</a>. Time was spent on administrative issues like overlap/conflict between Snappy and Kilimanjaro, plans for security review for Vladan&#8217;s symbol server and bug triage.</p>

<p>I&#8217;m usually really bad at noticing UI lag, but now my mind is focused on tab switching and I notice the lag every time click on tabs (keyboard switching is unaffected). We discussed how to fix tab lag I blogged about <a href="http://blog.mozilla.com/tglek/2012/04/10/argh-at-our-unresponsive-tab-strip-settimeoutfoo-0-can-be-very-harmful/">earlier</a>. It&#8217;s hard because there is some funny interaction between focus and drag &amp; drop and us switching tabs on mousedown. Neil will look into addressing focus issues this week.</p>

<p>Tim is addressing thumbnail capture slowness in bugs: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744388">744388</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=742594">742594</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726347">726347</a>.</p>

<p>Paolo is busy switching code away from synchronous places APIs: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=728168">728168</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=728174">728174</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=728142">728142 </a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739213">739213</a>.</p>

<p>The networking team is expected to make a decision this week on how to fix the big networking cache lock. See Nick&#8217;s <a href="https://wiki.mozilla.org/Performance/Snappy/2012-04-12#Fix_cache_-_hurley">notes</a> on options presented.</p>

<p>Thanks for feedback on preferred snappy update format: we&#8217;ll stick with cherries.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/10/argh-at-our-unresponsive-tab-strip-settimeoutfoo-0-can-be-very-harmful/">ARGH at Our Unresponsive Tab Strip: setTimeout(foo, 0) Can Be Very Harmful</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-10T02:51:01-07:00" pubdate data-updated="true">Apr 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I mentioned before, I&#8217;ve been a manager for a year. I&#8217;ve focused solely on paper pushing for the past 6 months. Even though I love programming, it&#8217;s surprisingly enjoyable to merely tell others what to do :) However, as all technical managers find out, eventually one gets very bored without doing something technical. So here it goes&#8230;</p>

<p><strong>Why The Frick Are My Tabs So Damn Laggy?</strong></p>

<p>****I noticed that tab switching has become unbearable lately. I finally filed a bug and with Gavin&#8217;s help investigated the brokenness. Turned out that we <a href="http://mxr.mozilla.org/mozilla-central/source/toolkit/content/widgets/tabbox.xml#800">awesomely</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setTimeout(do_stuff, 0)</span></code></pre></td></tr></table></div></figure>


<p>in the mousedown handler (bug 743877). This means that I click on my tab, only to suggest to the browser to schedule an event to be handled some time in the future. The browser will also go ahead and flush the existing event queue before getting to handling my event. I measured lag anywhere from 30 to 160+milliseconds before the browser even started handling my click.</p>

<p><em>This code is pretty ancient, why has tab switching gotten slow within the last few months?</em> Turns out we now take a tab thumbnail on every tabselect, which takes >100ms on my machine&#8230; We then carefully use async IO to store that image in our network disk cache. Unfortunately our cache uses locks in creative ways effectively making that code path synchronous (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=723577">723577</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=723582">723582</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=722033">722033</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=722034">722034</a>). See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=742594">742594</a> for thumbnail jank. Naturally, all of the above + cycle collection + garbage collection + etc gets scheduled right in the middle of handling tab switching :)</p>

<p>Thanks to a strategically misplaced setTimeout, the browser currently can spend a very long time not responding to user input (seconds sometimes). I bet we have a quite a few places that &#8220;solve&#8221; problems with setTimeouts like above.</p>

<p><strong>There is hope</strong></p>

<p>See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=743069">bug 743069</a> for some proof of concept patches on making tab switching more responsive. As far as I can see, there is no technical reason for us to not to have a buttery-smooth tab strip. Next steps are figuring out why XUL draws slowly, throttling other browser activity while interacting with tab strips, etc.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/05/snappy-april-5-change-in-meeting-format/">Snappy, April 5: Change in Meeting Format</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-05T06:52:12-07:00" pubdate data-updated="true">Apr 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Lawrence, thanks for posting <a href="http://lawrencemandel.com/tag/snappy/">snappy updates</a> while I was on leave.</p>

<p>Snappy meetings have gotten a bit dull lately. There hasn&#8217;t been much arguing about what needs fixing, or much discussion, everybody gave status updates and was in agreement. Going forward we will do less status updating, except for major developments to save some energy for discussion.</p>

<p>Discussion centered around personas&#8230;err themes <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=650968">murdering </a>firefox performance and goals for q2. Ehsan will post details how to reimplement themes. I made a separate <a href="http://taras.glek.net/blog/2012/04/05/snappy-apr-5-snappy-goals-for-q2/">post </a>about goals.</p>

<p>Vlad raised a question on whether we should proceed with <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=722243">cancellable </a>SQL queries given SQLite limitations. SQLite can only cancel all outstanding queries, which requires us to track carefully what requests are outstanding and/or do some SQLite feature development. Consensus was that we should proceed to avoid embarrassing situations like reading the places database <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=684513">backwards </a>during shutdown.</p>

<p>Lawrence also revamped the <a href="https://wiki.mozilla.org/Performance/Snappy/2012-04-05">meeting notes</a> to be more readable.  As an experiment I&#8217;m going to paste them in here. Let me know if you prefer my cherry-picking summaries from before.</p>

<h1>Snappy Apr. 5 Minutes</h1>

<ul>
<li>Sample Q2 goals: <a href="https://wiki.mozilla.org/Performance/Snappy#Snappy_TODO">https://wiki.mozilla.org/Performance/Snappy#Snappy_TODO</a></li>
<li>Chart showing Snappy bugs resolved in the last week <a href="https://wiki.mozilla.org/Performance/Snappy/Dashboard#Resolved_in_the_last_week">https://wiki.mozilla.org/Performance/Snappy/Dashboard#Resolved_in_the_last_week</a>.</li>
<li>did anyone attend the Intel sessions?

<ul>
<li>might be useful information at the next profiling session</li>
</ul>
</li>
</ul>


<h2>Actions</h2>

<p>No actions.</p>

<h2>Incoming</h2>

<ul>
<li>hardware acceleration: i disabled hwa on all macs in my family, and Firefox has been noticeably snappier across multiple types of macs. related bugs: bug 600763, bug 721273, bug 721892. should have someone from perf team or gfx dig in and at least confirm.

<ul>
<li>Taras asked to put on gfx q2 goals</li>
</ul>
</li>
</ul>


<h2>Projects</h2>

<h3>Persona slowness(ehsan?)</h3>

<p>Results from the past week</p>

<ul>
<li>issues discovered with animated personas and those that heavily use svg and css</li>
<li>Ehsan to summarize the issue in a blog/wiki</li>
<li>look at moving image decoding off of the main thread</li>
</ul>


<h3>Mainthread+Slow SQL (gavin/taras/vlad)</h3>

<p>Results from the past week</p>

<ul>
<li>Worked on cancellable sql (bug 722243), have to figure out if benefit from cancellable queries justifies additional locking</li>
</ul>


<p>Todo this week</p>

<ul>
<li>Ask SQLite guys about fine-grained cancels</li>
</ul>


<h3>Better DOM event/task scheduling - jst (telemetry)</h3>

<p>Results from the past week</p>

<ul>
<li>starting to work on slowing down parser in background tabs</li>
</ul>


<h3>Super-slow-startup investigations - vlad, taras</h3>

<p>Results from the past week</p>

<ul>
<li>Received batch of slow startup data from March</li>
</ul>


<h3>Startup optimizations - bbondy</h3>

<p>Results from the past week</p>

<ul>
<li>bbondy: Bug 692255 - WIll have implemented super review comments for prefetch</li>
</ul>


<h3>Front-end - Dietrich/bbondy</h3>

<p>Results from the past week</p>

<ul>
<li>Dashboard: <a href="https://wiki.mozilla.org/SnappyFrontEndDashboard">https://wiki.mozilla.org/SnappyFrontEndDashboard</a></li>
<li>QA chrome leak testing - should most affect frontend <a href="https://wiki.mozilla.org/QA/Snappy/Chrome_Leak_Testing">https://wiki.mozilla.org/QA/Snappy/Chrome_Leak_Testing</a></li>
<li>IE Migrator changes started landing, Safari coming soon after.</li>
<li>Tim Taubert put up AreWeSmallYet, tracking changes in build size: <a href="http://arewesmallyet.com/">http://arewesmallyet.com/</a></li>
</ul>


<p>Todo this week</p>

<ul>
<li>telemetry for home tab vs session restored</li>
<li>telemetry for # of tabs restored</li>
<li>taras: investigate if startup cache/omnijar is still of benefit</li>
</ul>


<h3>Profiler - jrmuizel/BenWa/Ehsan (and more)</h3>

<p>Todo this week</p>

<ul>
<li>There seems to be an issue with symbolication with latest SPS extension version</li>
</ul>


<h3>Nondestructive chromehang - vlad</h3>

<p>Results from the past week</p>

<ul>
<li>Co-ordinate with Softronics QA people &amp; Moz privacy review</li>
<li>bug 742008: Nightly profiling updates consistently failing</li>
</ul>


<p>Todo this week</p>

<ul>
<li>Integrate about-telemetry into Firefox as a bundled addon</li>
<li>Add a pass through mode so local symbolication server can pass symbolication requests to remote server (e.g. local Firefox symbols + remote Windows system symbols)</li>
</ul>


<h3>Peptest - mcote</h3>

<p>Results from the past week</p>

<ul>
<li>revision numbers, with links, now in peptest graphs as of March 30</li>
<li>results keep coming in!</li>
</ul>


<h3>GC pause reduction - billm</h3>

<p>Results from the past week</p>

<ul>
<li>bug 641025: incremental GC - disabled due to leaks</li>
<li>investigating leaks due to incremental GC</li>
<li>landed bug 716142 (allow multi-compartmental GCs), which enables:</li>
<li>worked on bug 739899, to keep compartment creation from stopping incremental GC</li>
<li>Multi compartment GCs should also enable scheduling smaller chunks of GC and CC.</li>
</ul>


<h3>CC pause reduction - smaug, mccr8 (meta bug 698919)</h3>

<p>Results from the past week</p>

<ul>
<li>smaug worked on trying to reduce the impact of leaked documents on the CC</li>
<li>mccr8 worked on bug 653191 (collapse SCCs of JS in CC graph)</li>
<li>remove more stuff from the CC graph (bug 740185)</li>
<li>QA is working on plan to test for leaked documents</li>
</ul>


<h4>bug710935 - measure lag in handling user input (needs owner)</h4>

<ul>
<li>bbondy: I&#8217;ll probably be starting on this next week, but if you have someone else please feel more than free to take :)</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/05/snappy-apr-5-snappy-goals-for-q2/">Snappy, Apr 5: Snappy Goals for Q2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-05T06:16:19-07:00" pubdate data-updated="true">Apr 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is time to set goals for the next 3 months at Mozilla. A lot of them should be Snappy-related.</p>

<p>As I mentioned before, we have made a lot of snappy progress lately. We identified a lot of problematic areas, fixed some of them and the end is in sight for others. It is extremely important that we maintain the current Snappy momentum, such that we can wrap up Snappy this year and move on to scaling Firefox on multiple cores, etc.</p>

<p>The following <a href="https://wiki.mozilla.org/Platform/2012-Q2-Goals#Perf">platform goals</a> have been proposed:</p>

<ul>
<li>Graphics: More rendering off main thread (this work is split between graphics/layout), Fix GFX acceleration lag (not yet on wiki)</li>
<li>Layout: More rendering off main thread (this work is split between graphics/layout), Invalidation via DisplayList Analysis</li>
<li>Video: Off main thread rendering (not yet on wiki)</li>
<li>DOM: Prevent [to a reasonable extent] background tabs from starving the main thread, Reduce CC pauses significantly when there are cycles to collect</li>
<li>Perf Team: Async local storage via blocking pageload, Combine IndexedDB/LocalStorage quotas to allow indexeddb to remove prompt, provide js file api (in workers) for all supported platforms, Reorder xul.dll on windows to speed up startup, continue exit(0) progress</li>
<li>Networking: Resolve listed high priority cache locking/async issues</li>
<li>Firefox: Fix top three Snappy offenders - lightweight themes, add-on manager, main thread SQL (under discussion, not on wiki)
We do a lot of work outside of our goal process, so above goals represent only the big ticket items that we&#8217;d like to see accomplished in the near future. There will be other snappy work going on too.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/04/powering-speakers-etc-with-bike-dynamo/">Powering Speakers, Etc With a Bike Dynamo</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-04T22:15:00-07:00" pubdate data-updated="true">Apr 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
I recently got rid of an old Pioneer receiver in favour of a tiny Class D amplifier. The class D amp is more efficient, sounds better and is approximately 10x cheaper. Did I mention, it&#8217;s tiny?<br /><br />While shopping for a variable voltage regulator for a power supply I discovered that EBay sells fun-looking <a href="http://www.ebay.com/itm/3-5-28V-to-1-25-26V-DC-DC-Converter-Boost-Buck-Step-Up-Step-Down-Voltage-Module-/260978204562?pt=LH_DefaultDomain_0&amp;hash=item3cc3835f92">1.5V-26V regulators.</a>..for $10. I&#8217;ve been eyeing the Busch + Müller E-WERK universal power supply(up to 13.5V) for a while now, but those sell for $110. It&#8217;s no fun spending a hundred bucks on a bike accessory that may not prove useful. I had no choice but to buy the EBay regulator.<br /><br />As my first experiment I tried powering a 12V MR16 light&#8230; it worked, but flickered like mad. A fat capacitor on the regulated side calmed the flicker. Great, now I can use indoor lights to illuminate my outdoor bike rides.<br /><br />Next I tried a 1-meter 12V LED strip, the strip uses a lot less current than the light bulb so it was quite happy.<br /><br />Then I wondered&#8230;could I power decent speakers using dynamo power? $8 <a href="http://www.ebay.com/itm/ws/eBayISAPI.dll?ViewItem&amp;item=220950831774&amp;ssPageName=ADME:L:OU:US:1123">ebay amp</a> later&#8230;yes I can! <br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Li9MPsIIXjI/T30nOwQeECI/AAAAAAAADCg/Ftik9IGKLlQ/s1600/IMGP4964.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="212" src="http://1.bp.blogspot.com/-Li9MPsIIXjI/T30nOwQeECI/AAAAAAAADCg/Ftik9IGKLlQ/s320/IMGP4964.JPG" width="320" /></a></div>Recipe: dynamo -&gt; rectifier bridge -&gt; high voltage smoothing capacitors -&gt; regulator -&gt; 16V 0.1F cap -&gt; (optional voltmeter) -&gt; ta2024 amp -&gt; speaker[s]<br /><br />By the way, do not buy this ta2024 amp, spend a few dollars extra and get a board with proper audio in. I had to desolder the weirdo 3pin connector and solder on a home-made audio cable. It also comes with extremely crappy capacitors and crappy terminals for remaining connections (vs decent stuff on the $14 ta204 amp).<br /><br />I think this voltage regulator will prove very handy for bike touring + camping. Should be especially fun once I combine the dynamo with a 3.5W solar panel. Buck/boost will prove very handy indeed.</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/29/home-automation-via-mi-casa-verde-vera/">Home Automation via Mi Casa Verde Vera 3 + Z-Wave</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-29T18:06:00-07:00" pubdate data-updated="true">Mar 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Our baby girl was born recently. We had the house heat off while we stayed at the birth center.<br /><br />Because we live in the future, we were able to to turn on the house heat(&amp; unlock front door) from the car while driving home. The house got down to 10C (50F) while we were away. Thanks to technology, we did not have to endure that temperature upon return :)<br /><br /><b>Vera/Z-Wave</b><br /><br />So far I have my thermostat, door lock, audio amp and some lights hooked up via Z-Wave. Mi Casa Verde <a href="http://www.amazon.com/gp/product/B0074WIVJ4/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;tag=stuff05e-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B0074WIVJ4">Vera 3</a> controller is the brains of the operation. It took a couple years before I got everything hooked up because the Vera 3 controller is the only viable option, yet is so damn expensive (fair cost should be ~$100). <br />I waited on opensource stuff to get good (ie <a href="http://linuxmce.com/">LinuxMCE</a> + o<a href="http://code.google.com/p/open-zwave/">penzwave</a>), but it seems like Z-Wave will be obsolete before there is any useful open source support for it.<br /><br /><b>Impressions</b><br />So far controlling the <a href="http://www.amazon.com/dp/B0052MHPP4/ref=as_li_ss_til?tag=stuff05e-20&amp;camp=0&amp;creative=0&amp;linkCode=as4&amp;creativeASIN=B0052MHPP4&amp;adid=06SXD7JN1SWXKBYY9W71">thermostat</a> from my phone/laptop is the killer feature of the system. We like to keep our house barely warm enough. Unfortunately we have an idiotic gas-powered hot air heating system which guarantees that some rooms are too hot while others are freezing. We can finally adjust house temperate depending on what room in the house we are using without running back/forth to the thermostat.<br />This became even more valuable once the baby arrived. Ellen can control temperature/light with one hand without yelling at me to help :)<br /><br />Controlling lights is cool, but it wasn&#8217;t a life-changer.&nbsp; Time taken for unlocking phone, connecting to the controller + execution lag are fairly similar to walking over to the damn light switch. I suspect Ellen will appreciate this more while she has her hands full with baby and can&#8217;t move easily.<br /><br />Same goes for the door lock. We have a code lock on one side of the house and a<a href="http://www.amazon.com/gp/product/B001NEK6JM/ref=as_li_ss_tl?ie=UTF8&amp;tag=stuff05e-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=B001NEK6JM"> z-wave/code lock</a> on the other. Frankly it takes longer to open the door via phone than to punch in the code. We haven&#8217;t used house-keys since we moved into the house&#8230;cos keys are a pain. Z-Wave makes it easy to change lock combination, check that the door is locked, etc, so it&#8217;s somewhat valuable.<br /><br />The coolest part of the system is ability to group individual device actions. We have a &#8220;house off&#8221; command that locks the door, turns off thermostat, turns of various lights/etc. It&#8217;s great to crawl into bed, poke at the phone and hear various things around the house shutting off.<br /><br /><b>Future</b><br />The Vera controller supports a lot more than just Z-Wave. It can do X10, custom scripts, respond to UPnP commands, schedule commands based on sun-set/rise times, etc. Various Z-Wave doodads also act as status indicators. In the future I plan to setup the thermostat to turn off while the door is open, open/close windows + turn on fans based of indoor/outdoor temp + time of night, etc. It is also possible to have the DHCP server on my lan report for when my phone appears/disappears so vera can turn off thermostat/lights automagically when we leave the house.<br /><br /><b>Alternatives</b><br />I probably spent $300 of real money on various Z-Wave gear + $300 of money suckered out of credit cards on this setup. There are alternatives.<br /><i> </i><br /><i>Lots of time approach</i>: I think one can do a lot of this on the cheap with xbee + atmega + relays. The thermostat is a little trickier, door lock is harder yet. This will involve reinventing the state machine behind Vera and interfacing with android, web, etc clients. I think it would be cool if open source people moved in this direction&#8230;google even made some noise about android-controlled light bulbs(and went quiet), but at the moment one would&nbsp; have to start from scratch.<br /><br /><i>I do what TV tells me:</i> People with more money than sense can pay Verizon/etc a <a href="https://shop.verizon.com/buy/Monitoring-Energy-Saving/Home-Control/Verizon-Home-Monitoring-and-Control/cat30006#order_tab">monthly fee</a> to do a lot of this. Verizon supports a strict subset of what the Vera controller does..but hey, they have TV ads.<br /><br /><i>Less-weird-stuff approach:</i> There are a couple different wifi thermostats on the market atm. <a href="http://www.amazon.com/dp/B004YZFU1Q/ref=as_li_ss_til?tag=stuff05e-20&amp;camp=0&amp;creative=0&amp;linkCode=as4&amp;creativeASIN=B004YZFU1Q&amp;adid=0T7A7B6RT7YD3PY5NJE1">This one</a> seems like a cheap way to go. Wifi is a lot less weird and proprietary than Z-Wave, but this gets you no closer to controlling lights, doors :)<br /><b><br /></b><br /><b>Conclusion</b><br />Now that the initial time/$$$ investment is made,<b> </b>I look forward to tightly coupling my security video, door bell, phone, sound, cooling systems. Motorized blind/window control is stupidly-expensive, so I&#8217;ll probably be rolling my own. There is lots of room left for energy savings + coolness factor improvements.<br /><br /></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Taras</div>
<div class='content'>
Apparently blogger doesn&#39;t send comment notifications by default. micasaverde forums are probably your best bet. </div>
</div>
<div class='comment'>
<div class='author'>Pedle Zelnip</div>
<div class='content'>
Awesome stuff, very cool.  Any tips for those of us who just bought a house and are thinking of looking into all this stuff (ie good resources on getting up to speed on it all)?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/16/snappy-march-15th/">Snappy, March 15th</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-16T08:39:30-07:00" pubdate data-updated="true">Mar 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Firefox 13 became Aurora this week. Firefox 13 is the first release that contains a significant amount of Snappy improvements. Some work got backported to 11 &amp; 12, but 13 is where the bulk of work landed. I am very proud of how much we accomplished in 13.</p>

<p>[caption id=&#8221;attachment_613&#8221; align=&#8221;alignnone&#8221; width=&#8221;600&#8221; caption=&#8221;Distribution of Snappy fixes&#8221;]<a href="/assets/images/2012-03-16-snappy-march-15th/ff13.png"><img src="/assets/images/2012-03-16-snappy-march-15th/ff13.png" alt="" /></a>[/caption]</p>

<p>I suspect the unnamed bar mostly consists of bugs that did not get version-tagged, but those should also be FF13.</p>

<p><strong>Smooth Scrolling</strong></p>

<p>About 10 years ago Avi Halachmi embarked on perfecting scrolling via his <a href="http://smoothwheel.mozdev.org/">smoothwheel extention</a>. It may be that Firefox was the first browser to feature kinetic scrolling (with his extension). This Tuesday Avi landed some of those smarts in Firefox; see bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=206438">206438</a>. I&#8217;m sad that it took us 10 years to notice an awesome UX improvement like this. However, it is awesome to work with community developers who can focus on in on a particular feature and perfect it to their liking. To me this is what open source is about: enabling amazing people to perfect their software experience (and have everybody else benefit). Thanks, Avi!</p>

<p>My secret plan is to clean up a few primary user experiences and freeze the rest of the browser while the user is interacting via bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=712478">712478</a>. Scrolling is one such activity, watching video is another, typing, etc.</p>

<p><strong>Peptest</strong></p>

<p>There is now a <a href="http://mrcote.info/peptest/">graph</a> for peptest results. Mark is figuring out how to deal with outlier, and considering integrating telemetry histograms.</p>

<p><strong>Cycle Collector</strong></p>

<p>Olli reduced CC lag observed after closing tabs like gmail, bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=734057">734057</a>.</p>

<p><strong>WIP</strong></p>

<p>We have fixed a lot of the low-hanging fruit and are working on larger projects at the moment. Going forward I&#8217;ll stick to mentioning projects when they get started, finish, or post builds for people to test.</p>

<p><strong>Plans for Firefox 14</strong></p>

<p>I&#8217;m very proud of Snappy fixes in Firefox 13, as a result I have high expectations for Firefox 14. The following are within reach:</p>

<ul>
<li>Get rid of remaining main thread SQL (including Local Storage).</li>
<li>Make background maintenance tasks interruptable</li>
<li>Fix themes to not ruin our <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=650968">startup</a></li>
<li>Teach Firefox to suspend background processing during<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=712478"> user interaction</a></li>
<li>Ensure that graphics acceleration does not <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=692557">regress </a>browser responsiveness</li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=662444">Exit </a>quickly</li>
<li>De-jank animations</li>
<li>Make our network cache more responsive</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/16/localstorage-pageload-perf/">LocalStorage Pageload Perf</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-16T03:26:51-07:00" pubdate data-updated="true">Mar 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sorry for the delay in posting this. We don&#8217;t yet have a frontend for tracking SQL performance in Firefox. Had to wait on Xavier to become available to do the <a href="http://people.mozilla.org/~xstevens/telemetry/slowsql/">manual reports</a> for me.</p>

<p>product
product_version
channel
sql
doc_count
sum_count
quantiles(min,0.25,0.5,0.75,0.95,max)</p>

<p>Firefox
12.0a2
aurora
INSERT INTO webappsstore2_temp (scope, key, value, secure, owner) SELECT scope, key, value, secure, owner FROM webappsstore2 WHERE scope = :scope AND NOT EXISTS ( SELECT scope, key FROM webappsstore2_temp WHERE scope = webappsstore2.scope AND key = webappsstore2.key )
2970
6676
(100.0,133.0,199.0,365.0,1731.0,244503.0)</p>

<p>Last column shows the time it takes to prepopulate DOM local storage for a webpage in milliseconds. It means in the worst case it took 4minutes before the filesystem decided to give us what we asked for. For 95% of the users reporting it took &lt; 1.7seconds to preload local storage, for 75% &lt; 0.36seconds, etc.</p>

<p>Generally IO is quite fast, but these terrible corner cases means that responsible software developers should always do async IO in interactive applications. Note that this has little to do with how we are accessing data from disk and everything to do with disk IO latency being non-deterministic.</p>

<p><strong>What about other SQL queries?</strong></p>

<p>Feel free to explore the other slow SQL queries in the product, most of them already have Snappy:P1 bugs filed. The plan for snappy is to systematically annihilate the worst performing IO in the browser ASAP.</p>

<p>This data shows why doing SQL IO in applications is both a curse and a blessing. On one hand, a general purpose relational database is always going to be slower than an application-specific storage mechanism. On the other hand, it is a very nice abstraction that makes analysis like this trivial.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/24/making-pages-load-faster/">Making pages load faster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/21/interesting-bugzilla-activity/">Snappy #45: The view from home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/">Snappy #44: Fixing tab switching in Vancouver</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p><h6>
  Copyright &copy; 2013 - Taras Glek - content on this site is licensed under the
Creative Commons Attribution Share-Alike License v3.0 or any later version.

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span></h6>
</p>
<script>
//indicate that content has been loaded
window._monitorContentLoaded = Date.now()
</script>
<script src="http://monitor-taras-glek-net.appspot.com/static/monitor.js">
</script>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
