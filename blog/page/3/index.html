
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="Landed This Week Neil Deakin joined the Snappy effort. He is working on eliminating pointless reflows in the tab strip. His fix for bug 752486 landed &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="https://raw.github.com/tarasglek/tarasglek.github.com/master/atom.xml" rel="subscribe-rss" title="subscribe via RSS">All RSS</a></li>
  
  <li><a href="https://raw.github.com/tarasglek/tarasglek.github.com/master/mozilla.xml"  title="subscribe via RSS">Mozilla RSS</a></li>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/06/snappy-aug-2/">Snappy, Aug 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-06T09:27:10-07:00" pubdate data-updated="true">Aug 6<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Landed This Week</strong></p>

<p>Neil Deakin joined the Snappy effort. He is working on eliminating pointless reflows in the tab strip. His fix for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=752486">bug 752486</a> landed, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=752376">752376</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=752496">752496</a> are next.</p>

<p>Brian Bondy landed removal of our prefetch-nuking code in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=770911">770911</a>. xul.dll preload is now always on based on our telemetry startup study in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765850">765850</a>.</p>

<p>Bill McCloskey landed the following improvements to reduce garbage collection pauses:</p>

<ul>
<li>bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=777919">777919 </a>- Free LifoAlloc chunks on background thread, instead of as part of the final IGC slice. This isn&#8217;t a problem for most people, but for some people on OSX it can take anywhere from 50ms to 250ms or more.</li>
<li>bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=778993"> 778993 </a>- Separate runtime&#8217;s gcMallocBytes from compartment&#8217;s gcMallocBytes, so we trigger less non-incremental GCs with many tabs open</li>
<li>bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=767209">767209 </a>- Make GC slices longer when not painting to avoid non-incremental GCs.
See Bill&#8217;s comments in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=767209">767209</a> for some insight into the complex heuristics that go into minimizing GC interruptions: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=767209#c3">comment 1</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=767209#c8">comment 2</a>.</li>
</ul>


<p><strong>Coming Soon</strong></p>

<p>In the coming week I expect to see some good optimizations land for page rendering, tab-switching behavior, more robust cache, etc.</p>

<p>Some Snappy people will be attending <a href="https://wiki.mozilla.org/MozCampEU2012">MozCamp.eu 2012</a> in Warsaw, Poland on September 8, 9. Expect to see lots of talk on profiling and other performance tools.</p>

<p>I hope to have above 15-20 Performance/Snappy people in Warsaw for the following week. This is not yet finalized. At the moment we are looking to see if there is a coworking space or a company in Warsaw who could host us.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/26/snappy-july-26-go-try-the-gecko-profiler/">Snappy, July 26: Go Try the Gecko Profiler!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-26T08:43:17-07:00" pubdate data-updated="true">Jul 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>See raw <a href="https://wiki.mozilla.org/Performance/Snappy/2012-07-26">notes</a> for details on mid-flight snappy work.</p>

<p><strong>Checkout the SPS Profiler</strong>!</p>

<p><a href="https://developer.mozilla.org/en/Performance/Profiling_with_the_Built-in_Profiler">SPS Gecko Profiler</a> has gotten a lot of praise this week on #perf. If you ever wonder the hell Firefox is doing with your CPU, give the profiler a try. For the past couple of weeks it has been able to label stacks with JS, URLs and even favicons. It&#8217;s likely that Mozilla may have shipped the world&#8217;s first profiler to feature favicons.</p>

<p>Having JS support is nice, it lead to the first 2 snappy addon bugs: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=777266">777266</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=777397">777397</a>. I documented how to act on addon responsiveness issues in the <a href="https://wiki.mozilla.org/Performance/Snappy#Snappy_Addons">snappy wiki</a>.</p>

<p>Whether you develop web pages, addons or are a core gecko hacker, the profiler may make the performance-analysis part of your life much more pleasant. Update: Benoit Girard <a href="http://benoitgirard.wordpress.com/2012/07/27/javascript-profiling-with-the-gecko-profiler-and-js-anti-pattern/">wrote</a> about the new profiler features.</p>

<p><strong>Things To Not Do On Startup </strong></p>

<p>Blair McBride did some <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726125#c16">digging</a>, there may be 15million users with signed extensions which can cause Firefox to do network IO (ie stall for a long time) on startup.</p>

<p>Brian Bondy landed a fix to lower IO priority of nuking our cache: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=773518">773518</a>. According to telemetry, 10-20% of startups feature cache nuking. It take a while to blow away 1GB of files on startup. Brian used telemetry to investigate causes for cache purges in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=774146">774146</a>. Based on this data, Brian will begin tackling what may be the oldest snappy bug so far: bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=105843">105843</a>. For more details on our cache see Nick Hurley&#8217;s <a href="http://todesschaf.org/posts/2012/07/25/cache-usage-results.html">blog post</a> (also see his link to a similar blog post from a Chrome person).</p>

<p><strong>More Responsive Tabs</strong></p>

<p>Tim Taubert made our new tab animation more pleasant in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=716108">716108</a>. Tim also landed a fix to halve jank caused by thumbnail capture in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=774811">774811</a>, this should result in better tab-switching experience. Stay tuned for more developer attention in this area.</p>

<p><strong>GC</strong></p>

<p>Jon Coppeard enabled incremental sweeping: bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=729760">729760</a>. This should result in slightly smaller GC pauses.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/25/telemetry-and-what-it-is-good-for-part-2-telemetry-achievements/">Telemetry and What It Is Good for: Part 2: Telemetry Achievements</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-25T08:55:21-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>An inquisitive mind sent me an email with a pointed question:</p>

<p>&#8220;Is there an example of someone who&#8217;s not you that had a burning question that would drive some sort of research or development activity and got it answered by telemetry?&#8221;</p>

<p>I forwarded his email and got a pretty fun survey. See below for a slightly edited version of emails I got. In addition to positive experiences below, people had a lot of complains about the telemetry experience.</p>

<p><em>Justin Lebar</em> Justin is probably the most vocal telemetry user who isn&#8217;t me. He <a href="http://jlebar.com/2012/5/30/A_ghost_story.html">blogged</a> about one of his more successful telemetry experiences. <em>Andrew McCreight</em> One telemetry stat I added is <a href="https://metrics.mozilla.com/data/content/pentaho-cdf-dd/Render?solution=metrics2&amp;path=%2Ftelemetry&amp;file=telemetryHistogram.wcdf&amp;bookmarkState={%22impl%22%3A%22client%22%2C%22params%22%3A{%22startDate%22%3A%222012-06-25%22%2C%22endDate%22%3A%222012-07-24%22%2C%22appVersion%22%3A%22%22%2C%22appName%22%3A%22Firefox%22%2C%22arch%22%3A%22%22%2C%22OS%22%3A%22%22%2C%22version%22%3A%22%22%2C%22channel%22%3A%22nightly%22%2C%22reason%22%3A%22idle-daily%22%2C%22appBuildID%22%3A%22%22%2C%22fromPlatformBuildID%22%3A%22%22%2C%22toPlatformBuildID%22%3A%22%22%2C%22excludeParam%22%3A%22%22%2C%22measure%22%3A%22CYCLE_COLLECTOR_NEED_GC%22%2C%22histogramCompareParam%22%3A%22appVersion%22%2C%22histogramVariablesParam%22%3A%22%22%2C%22platformBuildIDMode%22%3A%22LATEST%22%2C%22platformBuildIDTopCount%22%3A%2230%22%2C%22conditionsStatistic%22%3A%22%23conditionsStatistic%22%2C%22submissionsParameter%22%3A[[172394]]}}">CYCLE_COLLECTOR_NEED_GC</a>.  Sometimes a read barrier fails and we need to do a GC synchronously at the start of a CC, which is terrible for pause times.  Using telemetry, I confirmed my suspicion that this is very rare, and thus not worth trying to improve. Another state Olli added is <a href="https://metrics.mozilla.com/data/content/pentaho-cdf-dd/Render?solution=metrics2&amp;path=%2Ftelemetry&amp;file=telemetryEvolution.wcdf&amp;bookmarkState=%7B%22impl%22%3A%22client%22%2C%22params%22%3A%7B%22referenceDate%22%3A%222012-07-25%22%2C%22appNameParameter%22%3A%22%5BApplication%5D.%5BFirefox%5D%22%2C%22osParameter%22%3A%22%5BOS%5D.%5BWINNT%5D%22%2C%22channelParameter%22%3A%22%5BChannel%5D.%5Bnightly%5D%22%2C%22reasonParameter%22%3A%22%5BReason%5D.%5Bidle-daily%5D%22%2C%22histogramParameter%22%3A%22%5BHistogram%5D.%5BFORGET_SKIPPABLE_MAX%5D%22%2C%22histogramPopupTools%22%3A%22%22%2C%22duplicateHistogram%22%3A%22%23duplicateHistogram%22%2C%22medianButtonParam%22%3A0%2C%22scatterChart%22%3A%22%22%7D%7D">FORGET_SKIPPABLE_MAX</a>, which tracks the length of the CC cleanup phases we run.  As we made the cleanup more and more thorough, the times of these got longer and longer.  I think eventually this led Olli to try to fix the worst case cleanup phases, in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=747675">747675</a>.  He had this comment in there: &#8220;Based on the initial telemetry data, the patch doesn&#8217;t affect too much to the already low median times, but helps significantly with the worst 5%, so mean time decreases quite nicely.&#8221; Also, back around Firefox 13, Olli was using telemetry to observe the results of various CC optimizations, to assess their effectiveness, which he then used to decide whether or not to nominate various patches for landing on Aurora 12.  Telemetry let us see the reward part of the risk vs. reward tradeoff, and get some pretty big improvements into 12. Locally, I use <a href="https://addons.mozilla.org/en-US/firefox/addon/abouttelemetry/">about:telemetry</a> to get a sense of what the behavior on my local machine has been, but I suppose that doesn&#8217;t really fall under &#8220;telemetry&#8221; per se.  But it was quite useful during the Cycle Collector Crisis to see what CC behavior people had been seeing on their machines.</p>

<p><em>Olli Pettay</em> Thanks Andrew, very accurate summary of what I&#8217;ve been doing I tend to look at CC telemetry data daily. I very rarely use the histogram, since evolution is more interesting to me. Especially median time and also how P75 and P95 evolve. (The focus in this Q is to get lower bad times, so we should manage to drop P75 and P95) I use also <a href="about:telemetry">about:telemetry</a> locally since I tend to run builds with some patch, and I want to see if they affect badly to CC or GC times.</p>

<p><em>Taras</em> My blog is basically a collection of telemetry trivia :) I do not have testimonials from other people. However I heard that the silent-update team proved something about silent updates with telemetry, Necko team discovered that some optimizations were not, etc. I encourage other people who solved a problem with telemetry to either wrote a blog post or leave a comment.</p>

<p>In part 3 I will cover flaws in the current Telemetry experience.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/25/telemetry-and-what-it-is-good-for-part-1-nuts-and-bolts/">Telemetry and What It Is Good for: Part 1: Nuts and Bolts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-25T08:00:27-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Telemetry has been in production for about year. However, it turns out that many Mozillians do not know what it is good for. I presented <a href="http://people.mozilla.com/~tglek/fosdem2012/#/step-1">about</a> Telemetry at FOSDEM 2012, but have not had a chance to reach out to the core Mozilla developers because we haven&#8217;t had a Mozilla All-Hands since Telemetry got useful.</p>

<p><strong>Why Would One Use Telemetry?</strong></p>

<p>Telemetry exists for a single purpose: matching developer expectations with real Firefox behavior. My experience working on startup lead me to believe that is unreasonably complex to try to model real-world behavior in a lab setting and that it was actually easier to just measure real world behavior.</p>

<p>Anything that varies with IO, system configuration, user input, user workloads is easier to measure with Telemetry than to develop a useful finite benchmark for.</p>

<p><strong>Nuts &amp; Bolts</strong></p>

<p>Telemetry consists of two parts: client-side collection code + serverside frontend.</p>

<p>Client-side Telemetry currently records:</p>

<ul>
<li>simple measures: discrete numbers such as amount of ram, various startup times, flash version, etc</li>
<li><a href="http://mxr.mozilla.org/mozilla-central/source//ipc/chromium/src/base/histogram.h">histograms</a>: efficient one-dimensional means of gathering a range of values such as memory usage, cycle collection times, types of events occurring, etc. These are all specified in <a href="http://mxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/TelemetryHistograms.h">TelemetryHistograms.h</a>. You can view your local histograms by enabling telemetry and installing <a href="https://addons.mozilla.org/en-US/firefox/addon/abouttelemetry/">about:telemetry</a>.</li>
<li>slow sql statements: We record SQL statements that take over 100ms and whether they occur on main thread to prioritize <a href="https://wiki.mozilla.org/Performance/Snappy">Snappy</a> SQL work.</li>
<li>chromehangs: Nightly builds ship with frame-pointers so we can detect when Firefox pauses for over 5 seconds. Every time Firefox pauses, we record the backtrace. We started sending those a month ago, processing them on the serverside is a work-in-progress. These should be very handy for prioritizing work on making Firefox more responsive
One current limitation is that histograms are on-dimensional, there is no way to relate cycle collection times to uptime, memory usage, etc. We also go to great lengths to avoid collecting any personal identifiers. As a result we have no user UIDs and no ability to track how a user&#8217;s performance changes over time.</li>
</ul>


<p>Telemetry Frontend is a public dashboard that can be seen at <a href="http://arewesnappyyet.com/">arewesnappyyet.com</a>. Anyone can get a BrowserID login and look at our browser stats. Telemetry dashboard consists of two views:</p>

<ul>
<li>Telemetry Histograms: this is basically the same data as displayed in about:telemetry, but aggregated from our userbase. This was our original view and is likely to get folded into evolution in the future.</li>
<li>Telemetry Evolution: This view tracks how medians/percentiles gathered by histograms change over time. This is the view that most developers use.
Telemetry is not a technology unique to Firefox. I borrowed a lot of code from the Chromium implementation to get caught up. Microsoft also collects similar metrics.</li>
</ul>


<p>There are two differences between us and other browser vendors:</p>

<ol>
<li>We do not assign a unique id to every user. This sucks from a developer perspective as it makes it a lot harder to track performance over time, but we believe the privacy benefits are worth it.</li>
<li>We made our dashboards public because we would like to have our community actively involved in helping us track Firefox performance.
In part 2 I&#8217;ll discuss how various people at Mozilla use Telemetry.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/23/snappy-july-19-telemetry-experiments/">Snappy, July 19: Telemetry Experiments</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-23T10:56:56-07:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For the in-progress work and minor changes that landed see <a href="https://wiki.mozilla.org/Performance/Snappy/2012-07-19">non-meeting notes</a> for this week.</p>

<p>Jeff Muizelaar wrote an interesting <a href="http://muizelaar.blogspot.ca/2012/07/what-happens-when-you-switch-to-gmail.html">blog post</a> work involved in a tab switch on Mac.</p>

<p><strong>Windows Prefetch</strong>:<strong> Experimental Data vs Reality</strong></p>

<p>I once discovered that <a href="http://en.wikipedia.org/wiki/Prefetcher">Windows Prefetch</a> can adversely affect application startup times, bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=627591">627591</a>. Certain machines were showing performance to be much better with Windows prefetch disabled and using my &#8220;manual&#8221; dll preload code to warm up the cache. Manual dll preload is a win for loading large applications because it causes xul.dll to be read in sequentially rather than randomly via page-in (see my <a href="http://taras.glek.net/blog/2010/">blog posts</a> from 2010 for details of startup IO uglyness). Unfortunately Windows Prefetch + my preload code measured as a net regression. I found a weird API that seemed to return 0 when prefetch was broken and <a href="https://hg.mozilla.org/mozilla-central/rev/cc18551d5cc3#l1.19">guarded </a>preload on that.</p>

<p>We have recently backed out above heuristic based on a telemetry study in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757215">757215</a>. Perhaps this is why our startup numbers have started <a href="https://metrics.mozilla.com/data/content/pentaho-cdf-dd/Render?solution=metrics2&amp;path=%2Ftelemetry&amp;file=telemetryEvolution.wcdf&amp;bookmarkState={%22impl%22%3A%22client%22%2C%22params%22%3A{%22referenceDate%22%3A%222012-07-23%22%2C%22appNameParameter%22%3A%22[Application].[Firefox]%22%2C%22osParameter%22%3A%22[OS].[WINNT]%22%2C%22channelParameter%22%3A%22[Channel].[nightly]%22%2C%22reasonParameter%22%3A%22[Reason].[idle-daily]%22%2C%22histogramParameter%22%3A%22[Histogram].[SIMPLE_MEASURES_FIRSTPAINT]%22%2C%22histogramPopupTools%22%3A%22%22%2C%22duplicateHistogram%22%3A%22%23duplicateHistogram%22%2C%22medianButtonParam%22%3A0%2C%22scatterChart%22%3A%22%22}}">getting better</a> in Firefox 16?</p>

<p>Brian Bondy setup a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=764905">telemetry startup trial</a> to randomly delete prefetch, turn on dll preload. Last week Saptarshi Guha crunched some <a href="https://wiki.mozilla.org/Platform/Features/Telemetry">telemetry</a> numbers, see this <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=771745#c9">bugzilla comment</a>. Turned out Windows Prefetch is a huge win and dll preload is a tiny incremental improvement on top of that (rather than being a regression).</p>

<p>Moral of the story is: <em>do not rely on manual performance testing for workloads involving large amounts of IO</em>. Simulating a &#8220;typical&#8221; Windows machine is extremely hard without getting noisy numbers. Effort is better spent on analyzing noisy real-world numbers and running experiments in the wild.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/12/snappy-july-12-2012/">Snappy. July 12, 2012</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-12T08:30:52-07:00" pubdate data-updated="true">Jul 12<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Testing</strong></p>

<p>We discussed setting up <a href="http://wrla.ch/blog/2012/06/mobile-firefox-measuring-how-a-browser-feels">Eideticker</a>, for desktop Firefox responsiveness testing.</p>

<p>Andrew Halberstadt is making progress on a revised version of peptest. We are looking at loading talos pageset into individual tabs and tracking tab-switching</p>

<p>We also discussed how QA can help in helping us confirm + narrow down regressions found by telemetry.</p>

<p><strong>Necko</strong></p>

<p>Necko guys are continuing to remove main thread DNS resolution, are integrating a custom DNS resolver. Last week they landed a bunch of <a href="https://metrics.mozilla.com/data/">telemetry</a> to help them play cache-lock-whack-a-mole: bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763342">763342</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=767275">767275</a>.</p>

<p><strong>Profiler</strong></p>

<p>Our <a href="https://developer.mozilla.org/en/Performance/Profiling_with_the_Built-in_Profiler">profiler </a>should grok JavaScript now. See tomorrow&#8217;s nightly.</p>

<p><strong>GC</strong></p>

<p>Jon Coppeard put up a patch to do incremental sweeping. The cleanup phase of the GC is a major remaining continuous GC operation. This should help reduce remaining significant GC pauses.</p>

<p><strong>Perf Team</strong></p>

<p>Nicholas Chaim is almost done with setting a way to track main thread IO with XPerf in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=770317">770317</a>. We would like to track main thread network IO via xperf, but it&#8217;s not clear if xperf can report what thread IO operations happen on.</p>

<p><strong>Slow Startup</strong></p>

<p>Turns out Firefox validates some signed extensions on startup: bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726125">726125</a>. I think we finally have a good explanation for some of the ridiculously slow startups we&#8217;ve been looking at. Yuck.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/09/snappy-update-for-week-of-july-5th/">Snappy Update for Week of July 5th</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-09T07:49:31-07:00" pubdate data-updated="true">Jul 9<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Frontend</strong></p>

<p>Jared Wein discovered that our about:home was surprisingly expensive to load. He sped up the page by an estimated 30% in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765411#c11">765411</a>. Similarly, Tim Taubert is fixing our new tab page performance in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=753448">753448</a>.</p>

<p>Tim is also bravely attacking (via bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=769634">769634</a>) horrid performance issues with Firefox themes tracked by bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=650968">650968</a>.</p>

<p><strong>Profiling</strong></p>

<p>Alex Crichton added ability to profile JS in bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=761261">761261</a>. Benoit Girard is adding labels to the profiler to expose JS profiling info in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=707308">bug 707308</a>.  Same functionality will also allow us to add URLs to the stacks. This means that in addition to seeing what Firefox is busy with, the profiler will now provide context on what caused the processing (<a href="http://people.mozilla.com/~tglek/velocity2012/css/profiler.png">screenshot</a>). This is huge. Benoit also improved profiler timing data in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=769989">769989</a>.</p>

<p><strong>Slow Startup Research</strong></p>

<p>As I mentioned <a href="http://taras.glek.net/blog/2012/06/25/slow-startup-logging-help-wanted/">before</a>, Nicholas Chaim wrote an addon to track system IO usage while starting Firefox. He has since <a href="http://nchaim-moz2012.tumblr.com/post/26653615162/slow-startup-logging-add-on-0-12">updated </a>his addon to be hosted on <a href="https://addons.mozilla.org/en-US/firefox/addon/slow-startup-logging/">AMO</a> and to submit that data for analysis. If you suffer from slow Firefox startups, please help us identify common IO hogs by installing his addon. Please encourage friends with slow startups to do the same.</p>

<p>This addon lists names of processes and amount of IO they did. This is somewhat private information, we can&#8217;t gather this data via telemetry.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/02/snappy-june-21-28/">Snappy June 21, 28</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-02T07:06:24-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Necko team is busy squashing main-thread waits, see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765665">bug 765665</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=766973">bug 766973</a>.</p>

<p>Ehsan Akhgari turned on frame pointers on nightly channel: bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=764216">764216</a>. This means that one can now use the <a href="https://developer.mozilla.org/en/Performance/Profiling_with_the_Built-in_Profiler#Running%20the%20profiler">built-in profiler</a> on nightly builds. The main purpose behind the change was to collect more chromehang data(long Firefox UI stalls). Vlad Djeric lowered the chromehang reporting threshold to 5 seconds: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763124">bug 763124</a>. We are waiting on metrics to separate out chromehang reporting from telemetry pings: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763116">bug 763116</a>.</p>

<p>Nathan Froyd is making heroic progress on teaching our events to queue so they can be prioritized: bug <a href="http://bugzilla.mozilla.org/show_bug.cgi?id=715376">715376</a>.</p>

<p>Tim Taubert is working to reproduce a tab animation regression in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=752837">bug 752837</a>. He also taking over making Firefox themes less of a performance pig in<strong> </strong><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=650968">bug 650968</a> .</p>

<p>We had great success with eliciting data on slow startups in Nicholas Chaim&#8217;s <a href="http://nchaim-moz2012.tumblr.com/post/25647745019/slow-startup-logging-add-on">blog post</a>.  We confirmed that external processes can affect Firefox startup (we had evidence for this) and that we can detect those situations (great work Nicholas!). It will be a hard slog before we can bolt a pretty UI to the extension + integrate system diagnostics into Firefox. In the meantime I recommend that <a href="http://support.mozilla.org/en-US/home">SUMO</a> people start suggesting this extension to diagnose slow Firefox installs. Nicholas is working on a revision of the extension that records slow-IO-caused-startup situations on a server so we prioritize + turn these into detectable fingerprints.</p>

<p>William McCloskey fixed a nasty GC regression which caused GCs to run too often: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=768282">bug 768282</a>. Andrew McCreight sped up cycle collection when closing tabs: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=754495">bug 754495</a>. Olli Pettay enabled freeing DOM nodes directly (bypassing cycle-collection) when setting .innerHtml of non-empty DOM elements see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730639">bug 730639</a>.</p>

<p><strong>PS</strong></p>

<p>&#8220;The Performance of Open Source Applications&#8221; book is looking for <a href="http://www.aosabook.org/blog/2012/06/the-performance-of-open-source-applications/">contributors</a>. Would be cool if someone snuck some Mozilla wisdom in there.</p>

<p>Sorry for skipping the snappy update last week. These posts take a lot more effort than is reasonable and I needed to direct it at my talk last week. You can see my <a href="http://velocityconf.com/velocity2012">Velocity</a> slides <a href="http://people.mozilla.com/~tglek/velocity2012/">here</a>.</p>

<p>At least one person objected to the strong language used in the presentation (ie &#8220;dom local storage sucks&#8221;). I chose this language to emphasize the fact this isn&#8217;t a feature where one gets to weigh upsides vs downsides because the downsides are so severe. Most of the positive data on this is coming from what I believe to be unrepresentative benchmarks. I have not seen any other data points similar in quality to those reported by our <a href="https://metrics.mozilla.com/data/">telemetry</a>.</p>

<p>Btw, Jan Varga is close to removing our IndexedDB prompt(bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=758357">758357</a>), opening up IndexedDB as an alternative to DOM Local Storage(<a href="http://taras.glek.net/blog/2012/03/16/localstorage-pageload-perf/">which sucks</a>).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/25/slow-startup-logging-help-wanted/">Slow Startup Logging: Help Wanted</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-25T03:07:06-07:00" pubdate data-updated="true">Jun 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We have an intern working on an analysis tool to analyze how other Windows applications/services affect Firefox startup.</p>

<p><a href="http://nchaim-moz2012.tumblr.com/post/25647745019/slow-startup-logging-add-on"><img src="http://media.tumblr.com/tumblr_m616xmP5m81qz73vw.png" alt="" /></a></p>

<p>If you run Windows and you experience slow startups, please see Nicolas&#8217; <a href="http://nchaim-moz2012.tumblr.com/post/25647745019/slow-startup-logging-add-on">blog post</a> and submit data his addon gathers.</p>

<p>ps. I will not have time to post a Snappy update for last week. The next update will cover 2 weeks.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/18/40-60-of-startups-are-warm/">40-60% of Startups Are Warm?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-18T07:00:34-07:00" pubdate data-updated="true">Jun 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>_Note: click on the images if they get clipped by other content. Cold startups are those where data has to be read in from disk, warm ones are subsequent startups where the OS already has Firefox files in memory. _ I&#8217;m really surprised by the amount of warm startups done by Firefox users. Somewhere between 40% to 60% of startups are warm. On Linux you can see that by watching whether pagefaults occur while loading the firefox binary via <a href="https://metrics.mozilla.com/data/content/pentaho-cdf-dd/Render?solution=metrics2&amp;path=%2Ftelemetry&amp;file=telemetryHistogram.wcdf&amp;bookmarkState={%22impl%22%3A%22client%22%2C%22params%22%3A{%22startDate%22%3A%222012-05-19%22%2C%22endDate%22%3A%222012-06-17%22%2C%22appVersion%22%3A%22%22%2C%22appName%22%3A%22firefox%22%2C%22arch%22%3A%22%22%2C%22OS%22%3A%22%22%2C%22version%22%3A%22%22%2C%22channel%22%3A%22%22%2C%22appBuildID%22%3A%22%22%2C%22fromPlatformBuildID%22%3A%22%22%2C%22toPlatformBuildID%22%3A%22%22%2C%22excludeParam%22%3A%22%22%2C%22measure%22%3A%22EARLY_GLUESTARTUP_HARD_FAULTS%22%2C%22histogramCompareParam%22%3A%22appVersion%22%2C%22histogramVariablesParam%22%3A%22%22%2C%22platformBuildIDMode%22%3A%22LATEST%22%2C%22platformBuildIDTopCount%22%3A%2230%22%2C%22conditionsStatistic%22%3A%22%23conditionsStatistic%22%2C%22submissionsParameter%22%3A[[5229518]]}}">EARLY_GLUE_STARTUP_HARD_FAULTS</a> histogram.</p>

<p><a href="/assets/images/2012-06-18-40-60-of-startups-are-warm/glue.png"><img src="/assets/images/2012-06-18-40-60-of-startups-are-warm/glue.png" alt="" /></a></p>

<p>On Windows we do not have a good metric  for distinguishing cold startups from warm ones. However can look at the distribution of <a href="https://metrics.mozilla.com/data/content/pentaho-cdf-dd/Render?solution=metrics2&amp;path=%2Ftelemetry&amp;file=telemetryHistogram.wcdf&amp;bookmarkState={%22impl%22%3A%22client%22%2C%22params%22%3A{%22startDate%22%3A%222012-05-19%22%2C%22endDate%22%3A%222012-06-17%22%2C%22appVersion%22%3A%22%22%2C%22appName%22%3A%22firefox%22%2C%22arch%22%3A%22%22%2C%22OS%22%3A%22%22%2C%22version%22%3A%22%22%2C%22channel%22%3A%22%22%2C%22appBuildID%22%3A%22%22%2C%22fromPlatformBuildID%22%3A%22%22%2C%22toPlatformBuildID%22%3A%22%22%2C%22excludeParam%22%3A%22%22%2C%22measure%22%3A%22SIMPLE_MEASURES_FIRSTPAINT%22%2C%22histogramCompareParam%22%3A%22OS%22%2C%22histogramVariablesParam%22%3A%22darwin%2Clinux%2Cwinnt%22%2C%22platformBuildIDMode%22%3A%22LATEST%22%2C%22platformBuildIDTopCount%22%3A%2230%22%2C%22conditionsStatistic%22%3A%22%23conditionsStatistic%22%2C%22submissionsParameter%22%3A[[91510595]]}}">firstpaint histogram</a> and see that faster startups are more common than slower ones. Only a small minority of machines should be able to cold start a browser in &lt;3 seconds.  We have a lot of startups of various degrees of warmness.</p>

<p><a href="/assets/images/2012-06-18-40-60-of-startups-are-warm/firstpaint.png"><img src="/assets/images/2012-06-18-40-60-of-startups-are-warm/firstpaint.png" alt="" /></a></p>

<p>I have no explanation on why people restart Firefox so much. We know &lt; 10% of our shutdowns are <a href="https://metrics.mozilla.com/data/content/pentaho-cdf-dd/Render?solution=metrics2&amp;path=%2Ftelemetry&amp;file=telemetryHistogram.wcdf&amp;bookmarkState={%22impl%22%3A%22client%22%2C%22params%22%3A{%22startDate%22%3A%222012-05-19%22%2C%22endDate%22%3A%222012-06-17%22%2C%22appVersion%22%3A%22%22%2C%22appName%22%3A%22firefox%22%2C%22arch%22%3A%22%22%2C%22OS%22%3A%22%22%2C%22version%22%3A%22%22%2C%22channel%22%3A%22%22%2C%22appBuildID%22%3A%22%22%2C%22fromPlatformBuildID%22%3A%22%22%2C%22toPlatformBuildID%22%3A%22%22%2C%22excludeParam%22%3A%22%22%2C%22measure%22%3A%22SHUTDOWN_OK%22%2C%22histogramCompareParam%22%3A%22OS%22%2C%22histogramVariablesParam%22%3A%22darwin%2Clinux%2Cwinnt%22%2C%22platformBuildIDMode%22%3A%22LATEST%22%2C%22platformBuildIDTopCount%22%3A%2230%22%2C%22conditionsStatistic%22%3A%22%23conditionsStatistic%22%2C%22submissionsParameter%22%3A[[91503292]]}}">unclean</a> (most of those appear to be due to OS shutdown not waiting on Firefox, ie us shutting down too <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=662444">slowly</a>) so users aren&#8217;t crashing their browser and starting again. They are voluntarily closing the browser and then starting it soon after (ie OS doesn&#8217;t get a chance to flush Firefox out of filesystem cache).</p>

<p><a href="/assets/images/2012-06-18-40-60-of-startups-are-warm/shutdown_ok.png"><img src="/assets/images/2012-06-18-40-60-of-startups-are-warm/shutdown_ok.png" alt="" /></a></p>

<p>These patterns are pretty consistent across all of the Firefox release channels I checked, so I can&#8217;t blame warm startups on nightly users getting barraged with upgrade prompts. Can someone come up with a good theory(preferably with some evidence) for this?</p>

<p>Note telemetry only collects data once a day and requires the browser to be open for a few minutes before submitting data, data could be skewed here.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/26/test-rss/">test rss</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/24/making-pages-load-faster/">Making pages load faster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/21/interesting-bugzilla-activity/">Snappy #45: The view from home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p><h6>
  Copyright &copy; 2012 - Taras Glek - content on this site is licensed under the
Creative Commons Attribution Share-Alike License v3.0 or any later version.

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span></h6>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
