
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="Recently I dusted off outparamdel to see if I can get some refactorings landed. About a year ago, with the great QueryInterface outparamdelling &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tarasglek.github.com/blog/page/17/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tarasglek.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/19/outparamdelling-this-way-comes/">Outparamdelling This Way Comes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-19T07:06:08-07:00" pubdate data-updated="true">Sep 19<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I dusted off outparamdel to see if I can get some refactorings landed. About a year ago, with the great QueryInterface outparamdelling experiment we ended up with a smaller binary footprint and tiny performance gain, but that never landed due to us not wanting to break compatability yet. Ever since, outparamdel has been patiently bitrotting within <a href="http://developer.mozilla.org/en/docs/Pork">Pork</a> waiting for the day it&#8217;s allowed to break APIs.</p>

<p>Recently jst <a href="http://wiki.mozilla.org/Gecko:DeCOMtamination">listed</a> some private API candidates for deCOMtamination and I have been letting outparamdel loose on them for the past week. So far only one such <a href="http://hg.mozilla.org/mozilla-central/raw-rev/ec4733eb1bd8">change</a> has been committed, the rest are sitting in jst&#8217;s review queue. It&#8217;s exciting, as it&#8217;s the first ever application of outparamdel that didn&#8217;t get canned. For the whole list see the most recent bugs blocking my <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=430328">analysis metabug</a>.</p>

<p>Cool part about these patches is that after various outparamdel special-casing and manual cleanup the line count is reduced by 10-30% while maintaining existing functionality!</p>

<p>So far I haven&#8217;t touched much outside of content/, so if you know of any APIs that could have the outparam rotated into the return value, file some rewriting bugs against me.</p>

<p><strong>Rewriting with Mercurial</strong></p>

<p>Mercurial is now my favourite python program ever. It makes rewrites so easy. Here is my typical workflow:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'># Write an outparamdel input file specifying functions to rewrite..run outparamdel with pork-barrel to generate patch
</span><span class='line'>hg qimport -f autopatch.diff && hg qpush && hg qref #make the patch nice and readable
</span><span class='line'>hg qnew manual.diff #create a manual cleanup patch for cosmetic touchups and rewrites screwed up by macros#of course to submit patch for review, those two patches need to be combined
</span><span class='line'>#do manual stuff
</span><span class='line'>hg diff -r 19277 #produce a combined diff without loosing ability to edit each applied patch individually! For example, can regenerate the autopatch.diff with different outparamdel parameters or a bugfixed outparamdel. 19277 is a revision that has to be looked up with hg log, unfortunately there isn't a relative syntax to do hg diff -r "tip - 2"
</span></code></pre></td></tr></table></div></figure>


<p>This is a huge improvement over the ad-hoc workflow prior to hg switch when I was prototyping my tools. CVS + quilt don&#8217;t hold a candle to a modern revision control system.</p>

<p><strong>Prcheck</strong></p>

<p>I also have been doing another round of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=266048">prbool corrections</a>. Somehow I didn&#8217;t notice that the system stopped working due to the CVS->hg switch. Once again when reviving my nightly checker scripts, it was a pleasure to substitute all of the CVS hacks with mercurial commands.</p>

<p>I am waiting for the few remaining largeish (ie 3-4 bugs per file) patches to land before I can start submitting whackamole bugs with a single prbool correction per module.</p>

<p>It also seems that cairo and every other pre-C99 project have the same set of issues as Mozilla with their typedefed-int boolean types. Perhaps prcheck isn&#8217;t mozilla-specific at all.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/08/must_flow_throughlabel/">MUST_FLOW_THROUGH(&#8220;label&#8221;)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-08T03:54:57-07:00" pubdate data-updated="true">Sep 8<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some time ago, Igor mentioned that there is code in SpiderMonkey that pleads to the programmer that from a certain point in a function code must flow through a label(ie a finalizer block). <a href="http://developer.mozilla.org/en/docs/Treehydra">Treehydra</a> made it to possible to turn that weak plea into an error message when static <a href="http://developer.mozilla.org/En/Building_with_static_checking">checking is enabled</a>. See the <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=432917">bug</a> for more details. My favourite static analyses are all about turning informal &#8220;gurantees&#8221; into angry compiler complaints.</p>

<p>This is my first static analysis that landed in the mozilla-central tree. It&#8217;s also the simplest one and may be a decent starting point for solving similar problems. I&#8217;d be cool to see this particular feature utilized outside of SpiderMonkey. Unlike human-powered code-inspection, it excels at finding accidental early returns covered up by macros.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/03/error-presentation/">Error Presentation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-03T07:09:53-07:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Certain other cool open source projects are doing cool static analysis work. In this case, <a href="http://yoyodyne.ath.cx/ccc-analyze/buildkernel/2008-08-16-1/">here</a> is an analysis of one of my favourite operating systems projects, <a href="http://www.dragonflybsd.org/">DragonFly BSD</a>.</p>

<p>I&#8217;m blown away by the clean UI. The error filter and the interleaving of static analysis results in the source code are drool-inducing. This is powered by the <a href="http://clang.llvm.org/StaticAnalysis.html">clang checker</a>. Clang&#8217;s checker doesn&#8217;t yet do C++, doesn&#8217;t do application-specific checks and has a lot of false positives, but it&#8217;s an exciting preview of things to come.</p>

<p>Oh and I hope that DXR will have similar analysis awesomeness. In the future, I hope to see static analysis become almost as common as unit-testing.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/02/converging-elsa-strains/">Converging Elsa Strains</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-02T01:39:45-07:00" pubdate data-updated="true">Sep 2<span>nd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the purposes of this blog is to inform people that while the original <a href="http://www.cs.berkeley.edu/~smcpeak/elkhound/">Elsa author</a> is no longer actively developing it, Elsa is being used in production at Mozilla and is actively maintained within <a href="http://developer.mozilla.org/en/docs/Pork">Pork</a>.</p>

<p>Recently two previously unknown to me Elsa forks have come to my attention via comments on my blog. Both of these are extrimely cool and something we have been wanting:</p>

<ul>
<li><a href="http://ellcc.org/">ellcc</a> C (and soon C++) compiler via Elsa + LLVM. I&#8217;ve heard of attempts to get this to work before, but this looks like it is much further along than similar efforts.</li>
<li>Alex Telia&#8217;s souped up elsa with parser error recovery and an integrated C preprocessor among other awesomeness. See <a href="http://taras.glek.net/blog/2008/06/30/pork-09-in-the-wild/#comment-18303">this comment</a> for more details. Some of <a href="http://www.win.tue.nl/~lvoinea/VCN.html">these tools</a> are built on this Elsa fork.
Both of these projects are interested in converging on a single codebase. It sounds like Alex&#8217;s work will be ready for merging soon.</li>
</ul>


<p>I love open source.</p>

<p><strong>I&#8217;m Back</strong> <img src="http://photos-e.ak.facebook.com/photos-ak-sf2p/v323/152/124/53600064/s53600064_30661500_3965.jpg" alt="" /> Some might&#8217;ve noticed that I disappeared off the net for two weeks. I have a good excuse: I was getting married.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/14/meanwhile-in-a-parallel-universe/">Meanwhile in a Parallel Universe</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-14T01:48:04-07:00" pubdate data-updated="true">Aug 14<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Someone else is developing their own app-specific rewrite tools. In this case app-specific refers to <a href="http://people.imendio.com/richard/gtk-rewriter/">automating porting code</a> from gtk2 to gtk3. The approach is similar in that patches are produced, but it doesn&#8217;t look like a patch aggregating tool is written yet. Instead of the elsa/mcpp magic sauce, <a href="http://clang.llvm.org/">clang</a> is being used, so this is limited to C at the moment.</p>

<p>KDE folks are behind in automated code rewrites arms race, perhaps the trolls should try some <a href="http://developer.mozilla.org/en/docs/Pork">pork</a> to accelerate KDE3->4 transition :)</p>

<p>All kidding aside, it is awesome to see that less-manual-labour-through-compiler-assisted-refactoring approach is gaining mindshare.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/13/this-week-in-the-static-analysis-corner/">This Week in the Static Analysis Corner</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-13T08:55:50-07:00" pubdate data-updated="true">Aug 13<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>New Static Analysis Toys</strong></p>

<p>I have been catching up on my backlog of little bugs, here are some of the most notable ones.</p>

<p>Benjamin has been pushing the limits of what Dehydra can do for his DXR prototype which resulted in a couple of cool new features with one <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449075">new feature</a> breaking backwards compatibility. Sorry about that, it is for the greater good.</p>

<p>Dehydra now processes <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449428">more declarations</a>.</p>

<p>Dehydra uses JavaScript prototypes to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=447679">distinguish</a> between types and declarations.</p>

<p>Treehydra is now built by <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=437524">default</a> when building with a plugin-enabled compiler.</p>

<p>Treehydra now exposes the C++ frontend&#8217;s verbose and as-close-as-gcc-gets-to-written-code syntax tree via <a href="https://bugzilla.mozilla.org/attachment.cgi?id=332230">process_cp_pre_genericize</a>. Access to the early C++ AST should make it easier to automatically translate a certain class of C++ functions into JavaScript.</p>

<p>Coming soon: buildbot setup for Dehydra along with autobuilt debian packages.</p>

<p>Also, Benjamin&#8217;s GSoC student, Bo Yang, has been doing some awesome work making our static analysis toolchain work on mingw. In my mind, Bo sealed his awesomeness in not only getting Mozilla to build under mingw yet again, but also by fixing a couple of exciting compiler bugs on Win32.</p>

<p><strong>Path to 1.0</strong></p>

<p>For more information on these and other developments see the Dehydra 1.0 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=437502">tracking bug</a>.</p>

<p>I am not yet sure what the next release of Dehydra will be. My giant GTY patch to GCC is still awaiting review in a GCC developer&#8217;s inbox. Depending on whether that gets accepted I&#8217;ll continue releasing Dehydra 0.9.x with the current GCC patchset or delay a 1.0 release to work on getting the GCC plugin API reviewed and more or less finalized.</p>

<p><strong>Plans for Near Future</strong></p>

<p>I think I figured out the missing pieces needed to make outparamdel&#8217;s deCOMtamination patches acceptable, will work on that next. I&#8217;ll be continuing to clean up pork to be more developer-friendly. After the recent unhappyness involving bisection 10separate repositories at once, I&#8217;ve decided to merge pork into one giant repository and if someone just wants a couple smaller of pieces, those should be proken up at the package management level.</p>

<p>Additionally, I would like to start landing the SpiderMonkey analyses soon.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/11/oink-testsuite-within-pork-passes/">Oink Testsuite Within Pork Passes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-11T07:49:28-07:00" pubdate data-updated="true">Aug 11<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have never enjoyed the theory behind software engineering. It seems particularly depressing as it can be summarized as: &#8220;What can we learn from past software development experience in order to not repeat old mistakes such that we can come up with newer and shinier mistakes?&#8221;.</p>

<p>For that reason I haven&#8217;t been able to stick to any particular software development doctrine (paired, test-driven, OO, SOA, etc) and instead taken shortcuts to whatever is practical at the time.</p>

<p>One unfortunate result of such neglect is that the oink test suite ended up not being utilized. I tried it a couple of times while starting out with oink and it failed in many cumbersome ways. However, as pork evolved out of oink, I learned more about the &#8220;architecture&#8221; behind it, I fixed a couple of the issues that were causing funny make errors.</p>

<p>However one giant bug remained. Turned out other people were able to run the original oink testsuite, but not the equivalent one in pork. Fearing that I somehow screwed up Elsa, I spent way too long investigating the failure only to learn it wasn&#8217;t my <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=444805">fault</a>. Pork users: rejoice, the testsuite should run as expected now.</p>

<p>PS. I may not be a SENG believer, but I do think that open source + good version control + testsuites result in better software.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/04/summit/">Summit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-04T11:40:28-07:00" pubdate data-updated="true">Aug 4<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The past week rocked. I was especially impressed with the localizers. The guys who bear through translating an entire browser with associated websites to expose their country to an awesome browsing experience are simply electrifying.</p>

<p>It was great to see the South American guys again and to meet hordes of Europeans.</p>

<p>The most exciting outcome of the summit in my neck of the static analysis woods is that DXR (a semantically aware successor to MXR) will be rewritten from scratch in Python. Another reason to rejoice is that a tracing spidermonkey should make Treehydra ridiculously fast without much (or any) effort on my part.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/07/25/pull-pork-with-care/">Pull Pork With Care</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-07-25T07:01:04-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just committed the large giant change to bring down elsa&#8217;s namespace pollution to reasonable levels. Elsa code now is now using std::foo style, or using namespace std. As I mentioned before, Elsa&#8217;s string is now sm::string, a summary of how to perform similar renames is <a href="http://developer.mozilla.org/en/docs/Renaming_With_Pork">here</a>. The good news is that Pork will soon work out of the box with a modern toolchain.</p>

<p>For the handful of porkers out there, you need to hg pull &amp; hg up all of the pork repositories. This has been a use-case in why splitting up a codebase into a billion repositories is a bad idea:</p>

<p>a) Lovely, I have to do many commits instead of one</p>

<p>b) To top it off, now my users will curse my name while updating whatever pork repository that interests them most.</p>

<p>I feel like I&#8217;m going to throw up if I see any more C++ code diffs in the next 10minutes.</p>

<p>In contrast, while rewriting things on the Mozilla-scale is a lot less feasible manually, it is very rewarding to automate. Gotta love big C++ codebases.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/07/22/dogfooding-pork-oscon/">Dogfooding Pork & OSCON</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-07-22T03:26:19-07:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I wrote a class renamer and used it to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=445897">fix</a> my pork pet-pieve #1: a class named string that isn&#8217;t std::string. This has been a low priority goal for as long as I&#8217;ve been using Elsa. It&#8217;s pretty cool to apply a tool to fix itself.</p>

<p>The renamer is a 3x simpler than the next simplest tool. I plan to extend it to also rename class members. Renaming is the most trivial use-case for rewriting code, I plan to post a tutorial on using  the renamer in the near future.</p>

<p><strong>OSCON</strong></p>

<p>If you are at OSCON, you do not want to miss our <a href="http://en.oreilly.com/oscon2008/public/schedule/detail/4383">static analysis session</a> on Wednesday.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/18/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/16/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/">Snappy #44: Fixing tab switching in Vancouver</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/05/snappy-43-big-improvements-faster-startup-smoother-tabstrip/">Snappy #43: Big improvements: faster startup? Smoother tabstrip!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/26/snappy-42/">Snappy #42</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/18/snappy-41/">Snappy #41</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Taras Glek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
