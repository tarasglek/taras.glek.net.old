
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Living Dead Code - All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="The coolest part about my job is that I get to work on tasks that are cool, but typically are forever laid to rest in the would-be-cool-if-we-could- &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/2008/09/26/living-dead-code/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="https://raw.github.com/tarasglek/tarasglek.github.com/master/atom.xml" rel="subscribe-rss" title="subscribe via RSS">All RSS</a></li>
  
  <li><a href="https://raw.github.com/tarasglek/tarasglek.github.com/master/mozilla.xml"  title="subscribe via RSS">Mozilla RSS</a></li>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Living Dead Code</h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-26T03:58:37-07:00" pubdate data-updated="true">Sep 26<span>th</span>, 2008</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>The coolest part about my job is that I get to work on tasks that are cool, but typically are forever laid to rest in the would-be-cool-if-we-could-but-we-don&#8217;t-have-time-or-resources category. However as project code sizes increases, the usefulness/coolness ratio of static analysis grows and moves from would-be-cool, to nice-to-have to this-is-the-only-way. Now, I&#8217;m not sure where Mozilla lies on this scale, but I do know for sure that the giant codebase is an analysis treasure trove.</p>

<p><strong>Dead Code Motivation </strong></p>

<p>I have been talking about dead code detection in Mozilla for ages. As software changes, some pieces of code unintentially get left behind, but often there is no way to tell. It results in unnessary maintanance burden and increased footprint. In <a href="http://weblogs.mozillazine.org/roc/">roc</a>&#8217;s case randomly spotting dead methods may also involve a little IRC griping at me about not having any tools for it, even rudimentary ones. Between that and <a href="http://www.0xdeadbeef.com/weblog/?p=766">blizzard&#8217;s cheering</a> over reduced code size, I had no choice, but to give it a try once I had enough outparamdelling being reviewed.</p>

<p><strong>Dead Code Results</strong></p>

<p>First of, the approach described below seems to work well: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=457262">see bug</a> with initial results. Now I get a few thousand reported methods to inspect and refine the results.</p>

<p><strong>Dead Code Approach</strong></p>

<p>I&#8217;ve been pondering dead code detection since I&#8217;ve started working on this stuff. There are lots of ways to do it, but I finally settled on the dead-simplest one: method-level granularity. <a href="http://hg.mozilla.org/users/tglek_mozilla.com/deadlive/">Ingredients</a> are:</p>

<ul>
<li>Dehydra/Treehydra extraction JavaScript: Dehydra makes it easy to enumerate methods and class hierarchies. Treehydra makes it possible to extract every mention of a method from the code(except for <a href="http://mxr.mozilla.org/mozilla-central/source/content/events/src/nsEventListenerManager.cpp#206">pointers to virtual functions that were casted</a>&#8230;in that case we are left with vtable index and a type that the pointer was cast to). Additionally, Treehydra counts the number of AST nodes visited in every function body.</li>
<li>Shell script to aggregate the result of processing Mozilla source. Gotta admit, perl&#8217;s hashtables give GNU sort -u a run for its money.</li>
<li>Ocaml program to do the super-dumb algorithm. Classes with the same names, are assumed to be the same class. Method overloads are assumed to be a single method. All methods are assumed to be virtual. Every ClassType::FUNCTION_CALL call walks down to all children &amp; up through all the parents and marks the derived methods as called. Then all derivatives of scriptable XPIDL are filtered out and the uncalled methods are printed out. In order to find most exciting functions first, methods in the results are sorted by their AST count =D. <strong>Language Nerd Trivia:</strong> Why OCaml - because ADTs are no fun in other languages. Why is my OCaml so bad - because I lost the hang out if due to not writing anything it for the past 2 years.
I&#8217;m sure most people reading this will go: &#8220;Wait a minute, this is unsound if you don&#8217;t see the virtual function pointers?&#8221;, to which I reply: &#8220;Once I nuke the method and mozilla compiles successfully, it&#8217;s sound&#8221;. In reality someone could make a puny GCC patch to preserve more data in virtual function pointer assignments.</li>
</ul>


<p>Since this is all in early stages there a bunch of things I don&#8217;t deal with: method overloads, constructors, destructors and overloaded operators&#8230;.and templates. All function bodies are scanned, but some function names are a pain to deal with or they aren&#8217;t straightforward function calls in GCC so they don&#8217;t participate in the dead/alive contest.</p>

<p><strong>Where To Go From Here</strong></p>

<p>Well, once we run out of dead code detected by the primitive caveman approach above, we&#8217;ll have to investigate less conservative approaches possibly involving abstract interpretation and callgraphs.</p>

<p><strong>How To Get Involved in Screwing With Software Cost Models By Contributing Negative Line Counts </strong></p>

<p>This project has a lot of places to help out:</p>

<ul>
<li>work through the dead method list, filing bugs accordingly and deleting any related code</li>
<li>Extend the machinery to work on all non-static function</li>
<li>Try this on your favourite large codebase.</li>
<li>Write the virtual function pointer annotation patch :)</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Taras Glek</span></span>

      








  


<time datetime="2008-09-26T03:58:37-07:00" pubdate data-updated="true">Sep 26<span>th</span>, 2008</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mozilla/'>mozilla</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://taras.glek.net/blog/2008/09/26/living-dead-code/" data-via="tarasglek" data-counturl="http://taras.glek.net/blog/2008/09/26/living-dead-code/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2008/09/19/outparamdelling-this-way-comes/" title="Previous Post: Outparamdelling this way comes">&laquo; Outparamdelling this way comes</a>
      
      
        <a class="basic-alignment right" href="/blog/2008/10/07/note-this-is-not-called-yet-its-just-a-placeholder-for-future-changes/" title="Next Post: "NOTE: This is not called YET. It's just a placeholder for future changes."">"NOTE: This is not called YET. It's just a placeholder for future changes." &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/24/making-pages-load-faster/">Making pages load faster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/21/interesting-bugzilla-activity/">Snappy #45: The view from home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/">Snappy #44: Fixing tab switching in Vancouver</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p><h6>
  Copyright &copy; 2012 - Taras Glek - content on this site is licensed under the
Creative Commons Attribution Share-Alike License v3.0 or any later version.

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span></h6>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://taras.glek.net/blog/2008/09/26/living-dead-code/';
        var disqus_url = 'http://taras.glek.net/blog/2008/09/26/living-dead-code/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
