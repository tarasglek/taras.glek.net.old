<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: mozilla | All About Performance]]></title>
  <link href="http://taras.glek.net/blog/categories/mozilla/atom.xml" rel="self"/>
  <link href="http://taras.glek.net/"/>
  <updated>2013-01-10T17:34:00-08:00</updated>
  <id>http://taras.glek.net/</id>
  <author>
    <name><![CDATA[Taras Glek]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Snappy: 2012 Summary]]></title>
    <link href="http://taras.glek.net/blog/2013/01/04/snappy-2012-summary/"/>
    <updated>2013-01-04T15:46:00-08:00</updated>
    <id>http://taras.glek.net/blog/2013/01/04/snappy-2012-summary</id>
    <content type="html"><![CDATA[2012 was an exciting year for Snappy. Turning 'make it go faster' into a set of measurements and corresponding bugs to fix was hard. We learned a lot.

I'd like to summarize some of the most memorable Snappy accomplishments.

*Short version: Firefox is much more reponsive now.*

<!-- more -->

#Snappy Tools

Much of the year was spent on tooling for analyzing Firefox performance. [Gecko profiler](https://addons.mozilla.org/en-us/thunderbird/addon/gecko-profiler/) is my favourite new tool. Telemetry chromehangs, evolution and slowsql are also great for settling arguments. 

Many of the bugs below would not have gotten fixed without these tools.

#Cleaning up the Memory Collectors

In the beginning of the year it was common to suffer long (200-700ms for me) garbage and cycle collection pauses. I now rarely see pauses over 20ms in these areas. I suspect these were the most laborious improvements of 2012: see the huge number of blocking bugs in <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=641025">bug 641025</a>, <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=716598">bug 716598</a>. 

#SQLite Misuse

SQLite is a fine database, but it is much better at storing data robustly than accessing it efficiently. Firefox got nailed by the following footguns:

- overusing main-thread SQL queries
- performing expensive background queries
 
As if main-thread IO wasn't bad enough, turns out SQLite does not like running queries in parallel. Mixing sync/async queries invites race conditions where sync queries can end up waiting for many minutes at a time (hanging the UI) while "background" maintenance queries complete. There were too many such fixes to list.

###DOM Local Storage Caching

We ran into significant problems with Local Storage. In order conform to spec and not perform poorly, browsers are forced to maintain an in-memory cache (this is why Local Storage dominates in synthetic benchmarks: they are measuring memory bandwidth with no syscall, etc overhead).

* It became really popular in 2011-2012 despite a poor spec: main-thread reads and vagueness on when/whether data should hit disk.
* Local Storage cache was causing LS to be written out too often: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=714964">bug 714964</a>
* Local Storage cache was written on main-thread. For paranoid amusement it was then read back in after every writeout: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=807021">bug 807021</a>
* For some some reason to do with how our DOM works there is a second level of caching so local storage can actually use up 2x more memory in RAM than it does on disk. As a result the Local Storage cache is slated for a complete rewrite in <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=600307">bug 600307</a>.

I should note, I made a mistake and attributed [too much blame](/blog/2012/02/22/psa-dom-local-storage-considered-harmful/) to the Local Storage API. I will blog on the exact extent of Local Storage badness once I have a chance to access the relevant telemetry data.

Surprisingly, the Local Storage caching layer was so bad that the underlying SQLite footguns did not get to play a role in this tragedy.

#Async IO

For years people would argue on how patches should strive to use async APIs during patch review. Unfortunately even a little bit of sync IO has potential to cancel out the most elaborate async efforts.

We had no purely async storage APIs until recently. We now have one such API in [OS.File](http://dutherenverseauborddelatable.wordpress.com/2012/10/03/asynchronous-file-io-for-the-mozilla-platform/).


#UI Slowness

The following sadness was fixed:

###Startup

* Renaming directories with lots of files can take minutes on Windows: bad when it happens on startup: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=701909">bug 701909</a>.
* Firefox had a minor tendency to start loading webpages before UI is shown: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=756313">bug 756313</a>, <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=715402">bug 715402</a>.
* Q: What could be worse than loading pages before UI is shown? A: Executing synchronous proxy code: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=790370">bug 790370</a>, <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=767159">bug 767159</a>
* Firefox insisted on doing network activity to verify some extension jars on startup: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=726125">bug 726125</a>

###General

* Tab switching to some popular websites is roughly 10x faster now (too many bugs to list).
* Firefox tended be unresponsive during large downloads: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=789932">bug 789932</a>.
* In some situations hardware acceleration would slow down Firefox UI to a crawl: too many bugs to list here.

#2013

2012 was a good warm-up. We spent a substantial part of the year on tooling. If everything goes right, that should pay off in the coming year.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Making pages load faster]]></title>
    <link href="http://taras.glek.net/blog/2012/12/24/making-pages-load-faster/"/>
    <updated>2012-12-24T21:44:00-08:00</updated>
    <id>http://taras.glek.net/blog/2012/12/24/making-pages-load-faster</id>
    <content type="html"><![CDATA[I am not a web developer. I often learn about modern web dev tricks/trends by noticing how they impact overall Firefox performance. I prefer learning about perf topics from well-written blog posts. Bryan of Google page speed team [blogged](http://calendar.perfplanet.com/2012/make-your-mobile-pages-render-in-under-one-second/) on optimizing pageload speeds on mobile. The advice is good, but I have two minor warnings about it.

Suggestion to use `requestAnimationFrame` to delay loading resources is a good one. There is a gotcha: if you do something expensive in the requestAnimationFrame handler, it'll delay your first page draw (requestAnimationFrame fires as the browser prepares to paint. It's an ok place to start network requests, etc). If you do something expensive, use a chained requestAnimationFrame. Firefox recently started using a similar trick to display the UI faster in <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=715402">bug 715402</a>.

The suggestion to split up stylesheets is also good, but risky. I've seen this before, but I did not understand why websites sprinkled `<link rel="stylesheet">` throughout the page bodies. This can significantly degrade pageload times by causing redundant page restyles and reflows. Reflows can take hundreds of milliseconds on slow mobile devices, doing them multiple times is bad. Make sure to run your pages through a [profiler](http://anton.kovalyov.net/2012/12/17/firefox-profiler/) (or time the difference between relevant requestAnimationFrame callbacks). I saw a bad case of this in <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=718864">bug 718864</a>.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Snappy #45: The view from home]]></title>
    <link href="http://taras.glek.net/blog/2012/12/21/interesting-bugzilla-activity/"/>
    <updated>2012-12-21T12:09:00-08:00</updated>
    <id>http://taras.glek.net/blog/2012/12/21/interesting-bugzilla-activity</id>
    <content type="html"><![CDATA[I'm out until January. However, I setup a [new blog](/blog/2012/12/17/hello-octopress/), so why not test it with a snappy update. 

Benoit Girard sped up shutdown with:

* not forcing startup cache flushes on shutdown: <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=816656">bug 816656</a>. This speeds up exiting browser soon after startup.
* <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=818296">bug 818296</a>: . This may significantly reduce our shutdown times. We are waiting on more telemetry data to confirm.

Aaron Klotz made startup slightly faster by speeding up reading of some urlclassifier files in <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=810101">bug 810101</a>.

Vladimir Vukicevic landed <a title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=731974">bug 731974</a> which results in smoother browser animations and significantly improves the quality of tab-strip animations.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Coping with Flash hangs]]></title>
    <link href="http://taras.glek.net/blog/2012/11/26/coping-with-flash-hangs/"/>
    <updated>2012-11-26T01:45:11-08:00</updated>
    <id>http://taras.glek.net/blog/2012/11/26/coping-with-flash-hangs</id>
    <content type="html"><![CDATA[Blocking calls into the Flash plugin can temporarily hang Firefox. This is a problem because sometimes the user would be happy to kill the plugin to access their webpage and at other times it's the only way to get certain flash apps/games to load. If you suffer from flash-related hangs see Aaron's [blog post](http://dblohm7.ca/blog/2012/11/22/plugin-hang-user-interface-for-firefox/) for some builds to try. He is working a new [feature ](https://wiki.mozilla.org/Features/Firefox/Windows_Plugin_Hang_UI)to provide an option to kill hanging flash instances.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Snappy #44: Fixing tab switching in Vancouver]]></title>
    <link href="http://taras.glek.net/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/"/>
    <updated>2012-11-16T10:06:41-08:00</updated>
    <id>http://taras.glek.net/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver</id>
    <content type="html"><![CDATA[I joined our GFX+Layout teams for a workweek in Vancouver. Since profiling is most effective on slow machines, I brought along my trusty Acer  Aspire 722(slow 1.3ghz  CPU+ fast GPU) as my primary laptop. This hardware is great because the combination of a weak CPU + decent GPU means that if we accelerate things right the browser can perform quite well and if we don't, things get really slow. (analogous situation exists when fast CPUs are matched with slow GPUs).  
  
In the beginning of the week I quickly demoed menu lag, slow gmail tab switching([811472](https://bugzilla.mozilla.org/show_bug.cgi?id=811472)). Later in the week we looked at problematic Facebook tab switch times ([811474](https://bugzilla.mozilla.org/show_bug.cgi?id=811474)), Australis(see Matt's [post](http://matthew.noorenberghe.com/blog/2012/11/australis-tabs-where-are-you)) performance. By the end of the week tab switching improved by over 2x for both facebook and gmail. I don't have exact figures because while we can measure general tab switch trends via telemetry, there isn't a convenient way to do it on individual browsers yet. _Help wanted:_ would be great if someone could do up a barebone addon to monitor tab switching in bug [812381](https://bugzilla.mozilla.org/show_bug.cgi?id=812381), we'll fill in the rest.  
  
Jeff Muizelaar started out by speeding up checkbox drawing in bug [809603](https://bugzilla.mozilla.org/show_bug.cgi?id=809603)**.** Matt Woodrow sped up gmail by tweaking how we use layers in bugs [811927](https://bugzilla.mozilla.org/show_bug.cgi?id=811927),  [811570](https://bugzilla.mozilla.org/show_bug.cgi?id=811570).  
  
Matt made sure that we no longer draw layers with opacity of 0 in bug [811831](https://bugzilla.mozilla.org/show_bug.cgi?id=811831). Turns rendering lots of invisible text can be expensive.  
  
Workweeks are a more about communication than getting code landed, so it is impressive that Jeff, Matt and their reviewers managed to diagnose, fix, review, land such significant optimizations in a couple of days. My laptop of pain feels much faster already.  
  
In the coming weeks expect to see smoother tab switching, smoother animations, lower profiling overhead as we work through issues discussed during the workweek.
]]></content>
  </entry>
  
</feed>
