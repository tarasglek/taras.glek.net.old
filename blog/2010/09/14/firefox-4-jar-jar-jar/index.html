
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Firefox 4: jar jar jar - All About Performance</title>
  <meta name="author" content="Taras Glek">

  
  <meta name="description" content="Opening files is relatively expensive. There is a small syscall overhead and a higher overhead of fetching data from disk. Depending on physical data &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://taras.glek.net/blog/2010/09/14/firefox-4-jar-jar-jar/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="All About Performance" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">All RSS</a></li>
  
  <li><a href="/blog/categories/mozilla/atom.xml" rel="subscribe-rss" title="subscribe via RSS">Mozilla RSS</a></li>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <header role="banner"><hgroup>
  <h1><a href="/">All About Performance</a></h1>
  
    <h2>and other stuff by Taras Glek</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Firefox 4: Jar Jar Jar</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-14T03:32:35-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Opening files is relatively expensive. There is a small syscall overhead and a higher overhead of fetching data from disk. Depending on physical data layout and disk type, this can leave modern CPUs twiddling their thumbs for a long time while the disk skips around fetching all of the different file pieces.</p>

<p><strong>Optimization #1: Fewer naked files</strong></p>

<p>About two years ago I started gathering naked files on disk and shoving them into jars (eg <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=508421">bug 508421</a>). We made jar reading as efficient as possible by cleaning up code and switching to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=504864">mmap</a>. Eventually all application data files read from disk during &#8220;normal&#8221; startup ended up in jars. Unfortunately we ended up with four jars (toolkit, chrome + 2 locale jars), which felt silly. Due to limitations in XPCOM, a lot of naked files were still read from disk on version upgrades and extension installation.</p>

<p><strong>Optimization #2: One jar to rule them all</strong></p>

<p>Recently Michael Wu unleashed a can of <a href="http://blog.mozilla.org/mwu/2010/08/13/omnijar-how-does-it-work/">omnijar</a> whoopass. This was a massive effort driven by Android packaging requirements. Now application startup data is always being read from one file. This implies better data locality, less seeking, less waiting. One benefit of packing files tightly is that the OS speculatively reads data from disk in chunks that are usually larger than what the application requests. This makes reading nearby files free. Unfortunately there was no good way to predict the order that files will be accessed in without actually running Firefox, so there was more room for improvement.</p>

<p><strong>Optimization #3: Optimized jar layout </strong></p>

<p>So now that all of our data was in one file, the next logical step was to pack it intelligently. The only way to do this is to profile Firefox startup and then order the jar according to that. Unfortunately even once one lays out all of the jar entries sequentially we were still doing our io suboptimally. This was due to the fact that the zip index (jars are zip files) is traditionally located on the end of the file. Wikipedia <a href="http://en.wikipedia.org/wiki/ZIP_(file_format">entry</a>) has pictures to illustrate this.</p>

<p>In order to maximize readahead benefits and minimize disk seeks it would be nice to have the file index in the front of the file. So I changed our zip layout from</p>

<p><entry1><entry2>&#8230;<entryN><central directory><end of central directory></p>

<p>to</p>

<p><offset of the last entry read on startup><central directory><end of central directory><entry1><entry2>&#8230;<entryN><end of central directory></p>

<p>So all I did was change the offset in <end of central directory> to always be 4 (it can&#8217;t be 0 because anal zip programs balk at &#8220;NULL&#8221; central directory offsets). Then I added a second identical <end of central directory> entry to keep the the rule that the central directory is always followed by one. I also used the extra space forced upon me by overly vigilant zip programs to store a number indicating how much data we can preread on startup.</p>

<p>This yielded a 2-3x reduction in disk io over an unoptimized omnijar. This is on top of a >30-100x reduction achieved by going from naked files to omnijar.</p>

<p>The downside of my interpretation of the zip spec is that some zip programs expect zip files to be more rigid than the spec allows. Older versions of Firefox, Microsoft zip support in windows, WinRAR, unix zip programs, etc accept my optimized jars. 7zip, broken antivirus (it&#8217;s a security risk to be overly picky) <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=595473">fail</a>.</p>

<p>Trivia: this isn&#8217;t the first time we got tripped up by picky zip reading code. For example, the Android apk reader irritatingly insists at having a zip entry at byte zero of an Android package. This means that one can&#8217;t use apks to do the Android equivalent of self-extracting .exe files on Windows. Michael Wu is writing a custom library loader to deal with that :)</p>

<p><strong>Optimization #4: More Omnijar</strong></p>

<p>Feeling that omnijar wasn&#8217;t awesome enough, Michael Wu went ahead and <a href="http://blog.mozilla.org/mwu/2010/09/10/extensions-now-installed-packed/">omnijared extensions</a>. Most extensions will no longer need to be unpacked from xpi files. This also means that extension authors can opt to use the optimized jar format above to further speed up Firefox startup.</p>

<p><strong>Other jar optimizations</strong></p>

<p>Switching to jars via<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=520309"> startup cache</a> will allow us to further <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562406">optimize</a> our first startup. There is option of halving our jar IO further by actually making use of that readahead integer I added to optimized jars.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Taras Glek</span></span>

      








  


<time datetime="2010-09-14T03:32:35-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mozilla/'>mozilla</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://taras.glek.net/blog/2010/09/14/firefox-4-jar-jar-jar/" data-via="tarasglek" data-counturl="http://taras.glek.net/blog/2010/09/14/firefox-4-jar-jar-jar/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/09/09/help-wanted-does-fcntlf_preallocate-work-as-advertised-on-osx/" title="Previous Post: Help Wanted: Does fcntl(F_PREALLOCATE) Work as Advertised on OSX?">&laquo; Help Wanted: Does fcntl(F_PREALLOCATE) Work as Advertised on OSX?</a>
      
      
        <a class="basic-alignment right" href="/blog/2010/10/04/diagnosing-slow-startup/" title="Next Post: Diagnosing Slow Startup">Diagnosing Slow Startup &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/21/interesting-bugzilla-activity/">Snappy #45: The view from home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/coping-with-flash-hangs/">Coping with Flash hangs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/snappy-44-fixing-tab-switching-in-vancouver/">Snappy #44: Fixing tab switching in Vancouver</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/05/snappy-43-big-improvements-faster-startup-smoother-tabstrip/">Snappy #43: Big improvements: faster startup? Smoother tabstrip!</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tarasglek", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tarasglek" class="twitter-follow-button" data-show-count="false">Follow @tarasglek</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p><h6>
  Copyright &copy; 2012 - Taras Glek - content on this site is licensed under the
Creative Commons Attribution Share-Alike License v3.0 or any later version.

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span></h6>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'allaboutperformance-tarasglek';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://taras.glek.net/blog/2010/09/14/firefox-4-jar-jar-jar/';
        var disqus_url = 'http://taras.glek.net/blog/2010/09/14/firefox-4-jar-jar-jar/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
